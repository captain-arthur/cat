# Hydrophone 구성 요소

Hydrophone은 단순한 구조로 설계되어 있어 Sonobuoy보다 구성 요소가 간단합니다.

## 아키텍처 개요

```
┌─────────────────┐
│  Hydrophone CLI │  ← 사용자가 실행하는 명령어 도구 (단일 바이너리)
└────────┬────────┘
         │ kubectl/API
         ↓
┌─────────────────────────────────────────────┐
│         Kubernetes Cluster                  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   conformance 네임스페이스             │  │
│  │                                         │  │
│  │  ┌─────────────────────────────────┐  │  │
│  │  │  Conformance Test Pod            │  │  │
│  │  │  (공식 Kubernetes Conformance     │  │  │
│  │  │   이미지 실행)                     │  │  │
│  │  └─────────────────────────────────┘  │  │
│  │                                         │  │
│  │  (기타 리소스: ServiceAccount,         │  │
│  │   ClusterRoleBinding 등)               │  │
│  └─────────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

## 구성 요소 상세

### 1. CLI 유틸리티

단일 바이너리로 제공되는 커맨드라인 도구입니다.

| 특징 | 설명 |
|------|------|
| **설치 방법** | `go install sigs.k8s.io/hydrophone@latest` |
| **바이너리** | 단일 바이너리 (별도 구성 요소 없음) |
| **명령어** | `hydrophone run`, `hydrophone version` 등 |

**설치 방법:**

```bash
# Go 환경이 필요함
go install sigs.k8s.io/hydrophone@latest

# 설치 확인
hydrophone version
```

### 2. Conformance 네임스페이스

클러스터 내부에서 테스트를 실행하는 네임스페이스입니다.

| 역할 | 설명 |
|------|------|
| **테스트 실행** | 공식 Conformance 이미지를 사용하여 테스트 실행 |
| **리소스 관리** | 테스트에 필요한 리소스 (Pod, ServiceAccount 등) 생성 |
| **네임스페이스** | `conformance` 네임스페이스에서 실행 |

**특징:**
- `conformance` 네임스페이스에 배포됨
- 테스트 Pod를 생성하여 실행
- 공식 Kubernetes Conformance 이미지 사용

### 3. 공식 Conformance 이미지

Kubernetes 릴리스 팀에서 제공하는 공식 conformance 이미지를 사용합니다.

| 특징 | 설명 |
|------|------|
| **이미지 소스** | Kubernetes 릴리스 팀에서 제공하는 공식 이미지 |
| **버전** | 클러스터 Kubernetes 버전과 일치하는 이미지 사용 |
| **테스트 포함** | 공식 Conformance 테스트 스위트 포함 |

**이미지 예시:**
- `registry.k8s.io/conformance:v1.28.0`
- `registry.k8s.io/conformance:v1.29.0`

## 실행 흐름

```bash
# 1. 사용자가 CLI 명령 실행
hydrophone run --wait

# 2. CLI가 conformance 네임스페이스 생성
kubectl create namespace conformance

# 3. CLI가 테스트 Pod 생성 (공식 Conformance 이미지)
kubectl create pod conformance-test --image=registry.k8s.io/conformance:v1.28.0

# 4. Pod가 테스트 실행
Conformance Image → E2E 테스트 실행

# 5. 결과 수집 (e2e.log, junit_01.xml)
Pod 로그 → e2e.log
Pod 결과 → junit_01.xml

# 6. 사용자가 결과 확인
ls -la e2e.log junit_01.xml

# 7. 정리
kubectl delete namespace conformance
```

## 네임스페이스 구조

Hydrophone은 `conformance` 네임스페이스를 사용합니다:

```
conformance/
├── conformance (ServiceAccount)
├── conformance-test (Pod)           ← 테스트 실행 Pod
└── (기타 리소스)
```

## 권한 요구사항

| 리소스 | 권한 | 필요 이유 |
|--------|------|----------|
| **Namespace** | 생성/삭제 | `conformance` 네임스페이스 관리 |
| **Pod** | 생성/삭제/조회 | 테스트 Pod 실행 |
| **API Server** | 접근 | Conformance 테스트 실행 |
| **노드 접근** | 일부 테스트에서 필요 | 특정 테스트 실행 시 |

일반적으로 **cluster-admin** 권한이 필요합니다.

## Sonobuoy와의 구조 차이

| 항목 | Hydrophone | Sonobuoy |
|------|-----------|----------|
| **구성 요소** | 단일 바이너리 + Pod | CLI + Aggregator Pod + 플러그인 |
| **네임스페이스** | `conformance` | `sonobuoy` |
| **실행 방식** | 단일 Pod 실행 | Aggregator + 여러 플러그인 Pod |
| **결과 수집** | Pod 로그 직접 수집 | Aggregator가 플러그인 결과 취합 |

## 관련 문서

- [04-기본사용법.md](./04-기본사용법.md) - 기본 사용법 및 실행 흐름
- [03-Sonobuoy-비교.md](./03-Sonobuoy-비교.md) - Sonobuoy와의 구조 비교
