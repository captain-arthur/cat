# Hydrophone 옵션 및 고급 사용

Hydrophone의 고급 옵션 및 커스터마이징 방법을 설명합니다.

## 명령어 옵션

### 기본 옵션

| 옵션 | 설명 | 예시 |
|------|------|------|
| `--wait` | 테스트 완료까지 대기 | `hydrophone run --wait` |
| `--kubeconfig` | kubeconfig 파일 경로 지정 | `hydrophone run --kubeconfig /path/to/config` |
| `--namespace` | 네임스페이스 지정 (기본: conformance) | `hydrophone run --namespace my-conformance` |
| `--image` | Conformance 이미지 지정 | `hydrophone run --image registry.k8s.io/conformance:v1.28.0` |

### 테스트 필터링 옵션

| 옵션 | 설명 | 예시 |
|------|------|------|
| `--focus` | 특정 테스트만 실행 (정규식) | `hydrophone run --focus "\[Conformance\]"` |
| `--skip` | 특정 테스트 제외 (정규식) | `hydrophone run --skip "\[Slow\]"` |

### 출력 옵션

| 옵션 | 설명 | 예시 |
|------|------|------|
| `--output` | 결과 출력 디렉토리 지정 | `hydrophone run --output ./results` |

## 테스트 필터링

### E2E 테스트 태그 기반 필터링

특정 태그를 가진 테스트만 실행하거나 제외할 수 있습니다.

#### 주요 태그

| 태그 | 설명 |
|------|------|
| `[Conformance]` | 공식 Conformance 테스트 |
| `[Disruptive]` | 파괴적 테스트 (노드 재시작 등) |
| `[Serial]` | 순차 실행이 필요한 테스트 |
| `[Slow]` | 실행 시간이 긴 테스트 |
| `[Feature:XXX]` | 특정 기능 관련 테스트 |

#### 사용 예시

```bash
# Conformance 테스트만 실행
hydrophone run --focus "\[Conformance\]" --wait

# Slow 테스트 제외
hydrophone run --skip "\[Slow\]" --wait

# Disruptive 테스트 제외 (운영 환경)
hydrophone run --skip "\[Disruptive\]" --wait

# 여러 조건 조합
hydrophone run \
  --focus "\[Conformance\]" \
  --skip "\[Slow\]|\[Disruptive\]" \
  --wait
```

### 정규식 필터링

테스트 이름 기반으로도 필터링 가능합니다:

```bash
# 특정 테스트 이름 패턴만 실행
hydrophone run --focus "should.*Service" --wait

# 특정 테스트 제외
hydrophone run --skip "should.*Delete" --wait
```

## 이미지 버전 관리

### Kubernetes 버전과 일치

```bash
# 클러스터 Kubernetes 버전 확인
kubectl version --short

# 해당 버전의 conformance 이미지 사용
hydrophone run --image registry.k8s.io/conformance:v1.28.0 --wait
```

### 이미지 태그 예시

| Kubernetes 버전 | 이미지 태그 |
|----------------|------------|
| v1.28.0 | `registry.k8s.io/conformance:v1.28.0` |
| v1.29.0 | `registry.k8s.io/conformance:v1.29.0` |
| v1.30.0 | `registry.k8s.io/conformance:v1.30.0` |

**주의사항:**
- 클러스터 Kubernetes 버전과 이미지 버전을 일치시키는 것을 권장
- 버전 불일치 시 테스트 결과가 부정확할 수 있음

## 네임스페이스 관리

### 기본 네임스페이스

```bash
# 기본 네임스페이스 (conformance) 사용
hydrophone run --wait

# 정리
kubectl delete namespace conformance
```

### 커스텀 네임스페이스

```bash
# 커스텀 네임스페이스 사용
hydrophone run --namespace my-conformance-test --wait

# 정리
kubectl delete namespace my-conformance-test
```

### 네임스페이스 격리

여러 클러스터나 환경에서 동시에 실행할 때 네임스페이스를 분리할 수 있습니다:

```bash
# 환경별 네임스페이스 사용
hydrophone run --namespace conformance-prod --wait
hydrophone run --namespace conformance-staging --wait
```

## kubeconfig 관리

### 기본 kubeconfig

```bash
# 기본 kubeconfig 사용 (~/.kube/config)
hydrophone run --wait
```

### 특정 kubeconfig 지정

```bash
# 특정 kubeconfig 파일 사용
hydrophone run --kubeconfig /path/to/kubeconfig --wait
```

### 여러 클러스터 검증

```bash
# 클러스터별로 실행
for cluster in prod staging dev; do
  hydrophone run \
    --kubeconfig ~/.kube/config-$cluster \
    --namespace conformance-$cluster \
    --wait
done
```

## 결과 출력 관리

### 기본 출력

```bash
# 현재 디렉토리에 출력 (기본)
hydrophone run --wait
# → e2e.log, junit_01.xml 생성
```

### 출력 디렉토리 지정

```bash
# 특정 디렉토리에 출력
hydrophone run --output ./results --wait

# 또는 환경 변수 사용
export HYDROPHONE_OUTPUT=./results
hydrophone run --wait
```

### 결과 파일 백업

```bash
# 타임스탬프 추가하여 저장
timestamp=$(date +%Y%m%d-%H%M%S)
mkdir -p results/$timestamp
hydrophone run --output results/$timestamp --wait
```

## 고급 시나리오

### 빠른 검증 (Slow 테스트 제외)

```bash
# Slow 테스트 제외하여 빠른 검증
hydrophone run --skip "\[Slow\]" --wait
```

### 운영 환경 검증 (Disruptive 제외)

```bash
# Disruptive 테스트 제외하여 안전하게 검증
hydrophone run --skip "\[Disruptive\]" --wait
```

### Conformance만 집중 검증

```bash
# Conformance 태그만 실행
hydrophone run --focus "\[Conformance\]" --wait
```

### 특정 기능 테스트

```bash
# 특정 기능 관련 테스트만 실행
hydrophone run --focus "\[Feature:Networking\]" --wait
hydrophone run --focus "\[Feature:Storage\]" --wait
```

## 스크립트 예시

### 자동화 스크립트

```bash
#!/bin/bash
# hydrophone-test.sh

set -e

NAMESPACE="${NAMESPACE:-conformance}"
IMAGE="${IMAGE:-}"
FOCUS="${FOCUS:-}"
SKIP="${SKIP:-}"
OUTPUT="${OUTPUT:-./results}"

# 옵션 구성
OPTS="--namespace $NAMESPACE --wait"
[ -n "$IMAGE" ] && OPTS="$OPTS --image $IMAGE"
[ -n "$FOCUS" ] && OPTS="$OPTS --focus $FOCUS"
[ -n "$SKIP" ] && OPTS="$OPTS --skip $SKIP"
[ -n "$OUTPUT" ] && OPTS="$OPTS --output $OUTPUT"

# 실행
echo "Hydrophone 실행 중..."
hydrophone run $OPTS

# 결과 확인
if [ -f "$OUTPUT/e2e.log" ] && [ -f "$OUTPUT/junit_01.xml" ]; then
  echo "✅ 결과 파일 생성 완료"
  
  # 실패 항목 확인
  fail_count=$(grep -ic "fail" "$OUTPUT/e2e.log" || echo "0")
  echo "실패 항목: $fail_count"
  
  if [ "$fail_count" -gt 0 ]; then
    echo "❌ 테스트 실패 항목 발견"
    exit 1
  fi
else
  echo "❌ 결과 파일 없음"
  exit 1
fi

# 정리
echo "리소스 정리 중..."
kubectl delete namespace $NAMESPACE --ignore-not-found=true

echo "완료!"
```

**사용 예시:**

```bash
# 기본 실행
./hydrophone-test.sh

# 옵션 지정
NAMESPACE=my-conformance \
FOCUS="\[Conformance\]" \
SKIP="\[Slow\]" \
OUTPUT=./my-results \
./hydrophone-test.sh
```

### CI/CD 통합 스크립트

```bash
#!/bin/bash
# ci-hydrophone.sh

set -e

# 환경 변수 설정
KUBECONFIG="${KUBECONFIG:-~/.kube/config}"
OUTPUT_DIR="${OUTPUT_DIR:-./artifacts}"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# 결과 디렉토리 생성
mkdir -p "$OUTPUT_DIR/$TIMESTAMP"

# Hydrophone 실행
echo "Hydrophone 실행 중..."
hydrophone run \
  --kubeconfig "$KUBECONFIG" \
  --output "$OUTPUT_DIR/$TIMESTAMP" \
  --skip "\[Slow\]|\[Disruptive\]" \
  --wait

# 결과 확인
if [ ! -f "$OUTPUT_DIR/$TIMESTAMP/e2e.log" ]; then
  echo "❌ e2e.log 생성 실패"
  exit 1
fi

if [ ! -f "$OUTPUT_DIR/$TIMESTAMP/junit_01.xml" ]; then
  echo "❌ junit_01.xml 생성 실패"
  exit 1
fi

# 실패 항목 확인
fail_count=$(grep -ic "fail" "$OUTPUT_DIR/$TIMESTAMP/e2e.log" || echo "0")

echo "실패 항목: $fail_count"

# Gate 역할
if [ "$fail_count" -gt 0 ]; then
  echo "❌ Conformance 검증 실패: 배포 차단"
  exit 1
fi

# 정리
kubectl delete namespace conformance --ignore-not-found=true

echo "✅ Conformance 검증 성공"
```

## 관련 문서

- [04-기본사용법.md](./04-기본사용법.md) - 기본 사용법
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
- [09-CICD-통합.md](./09-CICD-통합.md) - CI/CD 파이프라인 통합
