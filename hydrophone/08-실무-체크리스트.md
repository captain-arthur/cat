# Hydrophone 실무 체크리스트

Hydrophone을 실무에 적용할 때 확인해야 할 사항들을 정리합니다.

## 실행 전 체크리스트

### 1. 환경 준비

| 항목 | 확인 사항 | 확인 방법 |
|------|----------|----------|
| **Go 환경** | Go 1.18 이상 설치 여부 | `go version` |
| **Hydrophone 설치** | Hydrophone 설치 여부 | `hydrophone version` |
| **Kubernetes 버전** | 클러스터 Kubernetes 버전 확인 | `kubectl version --short` |
| **권한** | cluster-admin 권한 보유 여부 | `kubectl auth can-i create pods --all-namespaces` |
| **리소스** | 클러스터에 충분한 리소스 여부 | `kubectl top nodes` |
| **이미지 접근** | 공식 Conformance 이미지 접근 가능 여부 | `kubectl run test --image=registry.k8s.io/conformance:v1.28.0 --rm -it --restart=Never -- echo "test"` |

### 2. 실행 옵션 선택

| 상황 | 권장 옵션 | 이유 |
|------|----------|------|
| **운영 클러스터** | `--skip "\[Disruptive\]"` | 서비스 중단 최소화 |
| **테스트 클러스터** | 전체 실행 | 전체 검증 가능 |
| **빠른 확인** | `--skip "\[Slow\]"` | 빠른 피드백 |
| **CNCF 인증 준비** | 전체 실행 | 인증 기준 충족 |

### 3. Air-gapped 환경 (사설 레지스트리)

| 항목 | 확인 사항 | 대응 방법 |
|------|----------|----------|
| **이미지 미러링** | Conformance 이미지가 사설 레지스트리에 있는지 | 사전에 이미지 미러링 |
| **이미지 지정** | `--image` 옵션으로 사설 레지스트리 이미지 지정 | `--image private-registry.io/conformance:v1.28.0` |
| **네트워크 접근** | 외부 레지스트리 접근 불가 여부 확인 | 사설 레지스트리 사용 설정 |

## 실행 중 체크리스트

### 1. 상태 모니터링

| 항목 | 확인 방법 | 비고 |
|------|----------|------|
| **Pod 상태** | `kubectl get pods -n conformance` | 정상 실행 중인지 확인 |
| **Pod 로그** | `kubectl logs -n conformance -l app=hydrophone --tail=100 -f` | 실시간 로그 확인 |
| **리소스 사용량** | `kubectl top pods -n conformance` | 리소스 부족 확인 |
| **네임스페이스 상태** | `kubectl get namespace conformance` | 네임스페이스 정상 확인 |

### 2. 문제 발생 시 대응

| 문제 | 확인 사항 | 대응 방법 |
|------|----------|----------|
| **Pod 실패** | Pod가 실패하는지 | `kubectl describe pod -n conformance` |
| **이미지 풀 오류** | 이미지 접근 오류 | 이미지 미러링 또는 네트워크 설정 확인 |
| **리소스 부족** | 클러스터 리소스 부족 | 노드 추가 또는 리소스 제한 조정 |
| **타임아웃** | 실행 시간이 너무 길어지는지 | `--skip` 옵션 사용 고려 |

## 실행 후 체크리스트

### 1. 결과 확인

| 항목 | 확인 방법 | 비고 |
|------|----------|------|
| **결과 파일 생성** | `ls -la e2e.log junit_01.xml` | 결과 파일 존재 확인 |
| **e2e.log 확인** | `cat e2e.log \| grep -i "fail"` | 실패 항목 확인 |
| **junit_01.xml 확인** | `cat junit_01.xml \| grep -i "failure"` | 실패 항목 확인 |
| **합격 여부** | 실패 항목 0건 여부 확인 | 합격 기준 충족 확인 |

### 2. 리포트 생성

| 산출물 | 생성 방법 | 비고 |
|--------|----------|------|
| **원본 결과 파일** | `e2e.log`, `junit_01.xml` | 현재 디렉토리에 저장 |
| **요약 리포트** | `e2e.log` 분석 + 문서화 | Markdown 파일로 저장 |
| **실패 항목 상세** | 실패 항목 분석 및 문서화 | 조치 가이드 포함 |
| **재현 방법** | 명령어 문서화 | `reproduction-guide.md` |

### 3. 정리

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **네임스페이스 정리** | `kubectl delete namespace conformance` | 클러스터 리소스 정리 |
| **Pod 정리 확인** | `kubectl get pods -n conformance` | 남은 Pod 없음 확인 |
| **결과 파일 백업** | 결과 파일을 안전한 위치에 저장 | 아티팩트 저장소 등 |

## 운영 환경 적용 체크리스트

### 1. 안전성 확인

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **Disruptive 테스트** | `--skip "\[Disruptive\]"` 옵션 사용 | 운영 환경 권장 |
| **워크로드 영향** | 기존 워크로드에 영향 없음 확인 | 모니터링 필요 |
| **실행 시간** | 서비스 시간대 고려 | 트래픽 낮은 시간대 실행 |

### 2. 권한 관리

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **cluster-admin 권한** | 실행 계정에 권한 부여 | RBAC 설정 확인 |
| **ServiceAccount** | 필요한 경우 ServiceAccount 생성 | 보안 강화 |
| **권한 범위** | 최소 권한 원칙 준수 | 가능하면 제한적 권한 |

### 3. 자동화 통합

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **CI/CD 통합** | 파이프라인에 Hydrophone 단계 추가 | 자동 실행 |
| **Gate 설정** | 실패 시 배포 차단 설정 | 합격 기준 적용 |
| **리포트 저장** | 결과를 아티팩트 저장소에 저장 | 추적 가능하도록 |
| **알림 설정** | 실패 시 알림 발송 | 슬랙/이메일 등 |

## 문제 해결 체크리스트

### 1. Go 환경 문제

```bash
# Go 버전 확인 (1.18 이상 권장)
go version

# Go PATH 확인
echo $GOPATH
echo $PATH | grep go

# PATH에 Go bin 추가
export PATH=$PATH:$(go env GOPATH)/bin
```

### 2. 권한 오류

```bash
# cluster-admin 권한 확인
kubectl auth can-i create pods --all-namespaces

# 권한 부여 (필요 시)
kubectl create clusterrolebinding hydrophone-cluster-admin \
  --clusterrole=cluster-admin \
  --serviceaccount=default:hydrophone
```

### 3. 이미지 풀 오류

```bash
# 이미지 접근 가능 여부 확인
kubectl run test --image=registry.k8s.io/conformance:v1.28.0 --rm -it --restart=Never -- echo "test"

# 사설 레지스트리 사용 시 이미지 미러링
# 또는 --image 옵션으로 사설 레지스트리 이미지 지정
hydrophone run --image private-registry.io/conformance:v1.28.0 --wait
```

### 4. 실행 중단된 테스트 정리

```bash
# 남아있는 리소스 확인
kubectl get pods -n conformance

# 정리
kubectl delete namespace conformance --ignore-not-found=true

# 강제 정리 (필요 시)
kubectl delete namespace conformance --force --grace-period=0
```

### 5. 결과 파일이 생성되지 않는 경우

```bash
# Pod 로그 확인
kubectl logs -n conformance -l app=hydrophone

# Pod 상태 확인
kubectl describe pod -n conformance -l app=hydrophone

# Pod 내부 확인
kubectl exec -n conformance -it <pod-name> -- ls -la /tmp
```

## CAT 통합 체크리스트

### 1. 검증 질문(Assertion) 정의

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **검증 질문 명확화** | "클러스터가 공식 Conformance를 만족하는가?" | Assertion 정의 |
| **합격 기준 수립** | "Conformance 테스트 100% 통과" | 수치/조건 명확화 |
| **예외 처리** | 예외 항목 및 승인 프로세스 정의 | 사전 정의 |

### 2. 기준(Policy) + 절차(Procedure) + 증거(Report)

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **기준 정의** | 합격 기준 문서화 | Policy 문서 |
| **절차 정의** | 실행 방법 문서화 | Procedure 문서 |
| **증거 관리** | 리포트 저장 및 추적 | Report 저장소 |

### 3. Gate 역할

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **자동 Gate** | 실패 시 배포 차단 | CI/CD 설정 |
| **수동 검토** | 필요한 경우 수동 검토 | 예외 승인 |
| **다음 단계 연결** | CAT 다음 단계로 진행 | kube-bench, kube-burner 등 |

## 정기 점검 체크리스트

### 주기별 체크리스트

| 주기 | 항목 | 비고 |
|------|------|------|
| **클러스터 배포 시** | Hydrophone 실행 및 합격 확인 | 인수 테스트 |
| **버전 업그레이드 시** | 업그레이드 전/후 Conformance 비교 | 호환성 확인 |
| **정기 점검 (월 1회)** | 정기적으로 Hydrophone 실행 | 지속적 검증 |
| **보안 정책 변경 시** | 변경 후 Conformance 재검증 | 영향도 확인 |

## Sonobuoy와의 비교 체크리스트

### Hydrophone 선택이 적합한 경우

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **빠른 검증만 필요** | 플러그인 기능 불필요 | Conformance 테스트만으로 충분 |
| **경량 도구 선호** | 최소한의 리소스 사용 | 단순한 실행 |
| **Go 환경 보유** | `go install` 가능 | 설치 간편 |

### Sonobuoy 선택이 적합한 경우

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **다양한 검증 필요** | 플러그인으로 확장 필요 | 로그 수집 등 |
| **종합 리포트 필요** | 다양한 플러그인 결과 통합 | 통합 리포트 |
| **패키지 관리자 선호** | Homebrew 등 패키지 관리자 사용 | 바이너리 설치 |

## 관련 문서

- [04-기본사용법.md](./04-기본사용법.md) - 기본 사용법 및 문제 해결
- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 활용
- [09-CICD-통합.md](./09-CICD-통합.md) - CI/CD 통합 가이드
