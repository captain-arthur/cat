# Hydrophone 기본 사용법

Hydrophone을 설치하고 실행하여 결과를 확인하는 전체 워크플로우를 설명합니다.

## 설치

### Go 환경 필요

Hydrophone은 Go로 작성되어 있어 Go 환경이 필요합니다.

**Go 설치 확인:**

```bash
go version
```

### 설치 방법

```bash
# 최신 버전 설치
go install sigs.k8s.io/hydrophone@latest

# 설치 확인
hydrophone version
```

### 바이너리 위치

설치 후 바이너리는 `$GOPATH/bin` 또는 `$HOME/go/bin`에 위치합니다.

```bash
# PATH에 추가 (필요 시)
export PATH=$PATH:$HOME/go/bin
```

## 기본 워크플로우

### 1. 테스트 실행

```bash
# 기본 실행 (완료까지 대기)
hydrophone run --wait
```

**옵션 설명:**

| 옵션 | 설명 | 필수 여부 |
|------|------|----------|
| `--wait` | 테스트 완료까지 대기 | 선택 (없으면 백그라운드 실행) |
| `--kubeconfig` | kubeconfig 파일 경로 지정 | 선택 (기본: ~/.kube/config) |
| `--namespace` | 네임스페이스 지정 (기본: conformance) | 선택 |

**백그라운드 실행 (선택적):**

```bash
# 백그라운드로 실행
hydrophone run

# 이후 상태 확인 (kubectl 사용)
kubectl get pods -n conformance
```

### 2. 상태 확인

실행 중인 테스트의 상태를 확인합니다:

```bash
# Pod 상태 확인
kubectl get pods -n conformance

# Pod 로그 확인
kubectl logs -n conformance -l app=hydrophone --tail=100 -f
```

**Pod 이름 예시:**
- `conformance-test-xxxxx`

### 3. 결과 확인

테스트가 완료되면 결과 파일이 현재 디렉토리에 생성됩니다:

```bash
# 결과 파일 확인
ls -la e2e.log junit_01.xml
```

**생성되는 파일:**

| 파일 | 설명 |
|------|------|
| `e2e.log` | 전체 테스트 실행 로그 |
| `junit_01.xml` | JUnit XML 형식의 테스트 결과 |

### 4. 결과 분석

#### e2e.log 확인

```bash
# 전체 로그 확인
cat e2e.log

# 실패 항목만 확인
grep -i "fail" e2e.log

# 성공 항목 확인
grep -i "pass" e2e.log
```

#### junit_01.xml 확인

```bash
# JUnit XML 파일 확인
cat junit_01.xml

# XML 파서로 분석 (예: xmllint)
xmllint --format junit_01.xml

# 실패한 테스트 확인
grep -i "failure" junit_01.xml
```

### 5. 리소스 정리

테스트가 완료되면 클러스터 리소스를 정리합니다:

```bash
# conformance 네임스페이스 삭제
kubectl delete namespace conformance

# 또는 강제 삭제 (필요 시)
kubectl delete namespace conformance --force --grace-period=0
```

## 실전 예시: 전체 워크플로우

```bash
#!/bin/bash

# 1. 테스트 실행
echo "Hydrophone 테스트 시작..."
hydrophone run --wait

# 2. 결과 확인
echo "결과 확인 중..."
if [ -f "e2e.log" ]; then
  echo "✅ e2e.log 생성 완료"
  # 실패 항목 확인
  fail_count=$(grep -i "fail" e2e.log | wc -l)
  echo "실패 항목: $fail_count"
else
  echo "❌ e2e.log 없음"
fi

if [ -f "junit_01.xml" ]; then
  echo "✅ junit_01.xml 생성 완료"
else
  echo "❌ junit_01.xml 없음"
fi

# 3. 결과 파일 저장
mkdir -p results
mv e2e.log junit_01.xml results/ 2>/dev/null || true

# 4. 정리
echo "리소스 정리 중..."
kubectl delete namespace conformance --ignore-not-found=true

echo "완료!"
```

## 고급 사용법

### 특정 테스트만 실행

```bash
# 특정 테스트만 실행 (focus)
hydrophone run --focus "\[Conformance\]" --wait

# 특정 테스트 제외 (skip)
hydrophone run --skip "\[Slow\]" --wait

# 여러 조건 조합
hydrophone run --focus "\[Conformance\]" --skip "\[Slow\]" --wait
```

### 이미지 버전 지정

```bash
# 특정 Kubernetes 버전의 conformance 이미지 사용
hydrophone run --image registry.k8s.io/conformance:v1.28.0 --wait
```

**이미지 버전 확인:**

```bash
# 클러스터 Kubernetes 버전 확인
kubectl version --short

# 해당 버전의 conformance 이미지 사용 권장
```

### kubeconfig 지정

```bash
# 특정 kubeconfig 파일 사용
hydrophone run --kubeconfig /path/to/kubeconfig --wait
```

### 네임스페이스 지정

```bash
# 특정 네임스페이스에 배포
hydrophone run --namespace my-conformance --wait

# 정리 시에도 동일한 네임스페이스 지정
kubectl delete namespace my-conformance
```

## 문제 해결

### 일반적인 문제

#### 1. 권한 오류

```bash
# cluster-admin 권한 확인
kubectl auth can-i create pods --all-namespaces

# 권한 부여 (필요 시)
kubectl create clusterrolebinding hydrophone-cluster-admin \
  --clusterrole=cluster-admin \
  --serviceaccount=default:hydrophone
```

#### 2. 이미지 풀 오류

```bash
# 이미지 접근 가능 여부 확인
kubectl run test --image=registry.k8s.io/conformance:v1.28.0 --rm -it --restart=Never -- echo "test"

# 사설 레지스트리 사용 시 이미지 미러링 필요
```

#### 3. 실행 중단된 테스트 정리

```bash
# 남아있는 리소스 확인
kubectl get pods -n conformance

# 강제 정리
kubectl delete namespace conformance --force --grace-period=0
```

#### 4. 결과 파일이 생성되지 않는 경우

```bash
# Pod 로그 확인
kubectl logs -n conformance -l app=hydrophone

# Pod 상태 확인
kubectl describe pod -n conformance -l app=hydrophone

# 결과 파일이 Pod 내부에 있는 경우 (볼륨 마운트 확인)
kubectl exec -n conformance -it <pod-name> -- ls -la /tmp/results
```

#### 5. Go 환경 문제

```bash
# Go 버전 확인 (1.18 이상 권장)
go version

# Go PATH 확인
echo $GOPATH
echo $PATH | grep go

# PATH에 Go bin 추가
export PATH=$PATH:$(go env GOPATH)/bin
```

## 실무 활용 팁

### 빠른 검증

```bash
# 빠른 Conformance 검증 (Slow 테스트 제외)
hydrophone run --skip "\[Slow\]" --wait
```

### 상세 로그 확인

```bash
# 실행 중 실시간 로그 확인
kubectl logs -n conformance -l app=hydrophone --tail=100 -f
```

### 결과 파일 백업

```bash
# 결과 파일 타임스탬프 추가하여 저장
timestamp=$(date +%Y%m%d-%H%M%S)
mkdir -p results/$timestamp
mv e2e.log junit_01.xml results/$timestamp/
```

### 여러 클러스터 검증

```bash
# 클러스터별로 실행
for cluster in cluster1 cluster2 cluster3; do
  echo "Testing $cluster..."
  hydrophone run --kubeconfig ~/.kube/config-$cluster --wait
  mkdir -p results/$cluster
  mv e2e.log junit_01.xml results/$cluster/
done
```

## 관련 문서

- [05-옵션및고급사용.md](./05-옵션및고급사용.md) - 고급 옵션 및 커스터마이징
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
- [09-CICD-통합.md](./09-CICD-통합.md) - CI/CD 파이프라인 통합
