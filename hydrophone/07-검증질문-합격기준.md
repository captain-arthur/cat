# 검증 질문(Assertion) 및 합격 기준

Hydrophone을 사용하여 검증할 수 있는 **검증 질문(Assertion)**과 **합격 기준**을 정의합니다.

## 검증 질문(Assertion) 정의 원칙

### 핵심 원칙

**"도구"가 아니라 "검증 질문(Assertion)"으로 카테고리를 고정**

- 도구는 경계가 모호하다
- 같은 도구라도 질문이 다르면 다른 카테고리에 넣어도 된다
- 필요하다면 "Primary 카테고리 1개 + Secondary 태그"로 운영

### "그래서 우리는 뭘 통과하면 이 클러스터를 운영 승인할 수 있는가?"

- **기준(Policy)**: 수치/조건으로 명확히 정의
- **절차(Procedure)**: 검증 실행 방법
- **증거(Report)**: 결과 리포트 산출물

## Hydrophone 관련 검증 질문(Assertion)

### 1. 기본 자격 검증

#### Assertion 1.1: "클러스터가 공식 Conformance를 100% 통과하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "클러스터가 공식 Kubernetes Conformance를 100% 통과하는가?" |
| **테스트 방법** | `hydrophone run --wait` |
| **합격 기준** | **모든 필수 Conformance 테스트 100% 통과 (예외 0건)** |
| **실행 환경** | 테스트 환경 또는 운영 환경 |
| **실행 시간** | 전체 테스트 실행 시간 (1-3시간) |
| **비고** | CNCF 인증 준비 시 필수 |

**실행 명령어:**

```bash
hydrophone run --wait
```

**합격 판단:**

```bash
# 실패 항목 확인
fail_count=$(grep -ic "fail" e2e.log || echo "0")

if [ "$fail_count" -gt 0 ]; then
  echo "❌ Conformance 검증 실패: 운영 승인 불가"
  exit 1
fi
```

#### Assertion 1.2: "운영 환경에서 기본 자격을 확인했는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "운영 환경에서 기본 자격을 확인했는가?" |
| **테스트 방법** | `hydrophone run --skip "\[Disruptive\]" --wait` |
| **합격 기준** | **Non-disruptive Conformance 테스트 통과 (실패 0건)** |
| **실행 환경** | 운영 환경 가능 (비파괴적) |
| **실행 시간** | Disruptive 제외 시 더 짧음 |
| **비고** | **운영 환경 기본 검증 권장** |

**실행 명령어:**

```bash
hydrophone run --skip "\[Disruptive\]" --wait
```

**합격 판단:**

```bash
# 실패 항목 확인
fail_count=$(grep -ic "fail" e2e.log || echo "0")

if [ "$fail_count" -gt 0 ]; then
  echo "❌ Conformance 검증 실패: 운영 승인 불가"
  exit 1
fi
```

### 2. 빠른 검증

#### Assertion 2.1: "핵심 Conformance 테스트를 빠르게 확인할 수 있는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "핵심 Conformance 테스트를 빠르게 확인할 수 있는가?" |
| **테스트 방법** | `hydrophone run --skip "\[Slow\]" --wait` |
| **합격 기준** | **Slow 테스트 제외 시 핵심 테스트 통과** |
| **실행 환경** | 개발/테스트 환경 또는 빠른 확인 |
| **실행 시간** | 30분-1시간 (Slow 제외) |
| **비고** | 빠른 피드백이 필요한 경우 |

**실행 명령어:**

```bash
hydrophone run --skip "\[Slow\]" --wait
```

### 3. 표준 준수 검증

#### Assertion 3.1: "표준 API 동작이 Kubernetes 표준과 차이가 없는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "표준 API 동작/리소스 스펙/스케줄러 동작이 Kubernetes 표준과 차이가 없는가?" |
| **테스트 방법** | `hydrophone run --focus "\[Conformance\]" --wait` |
| **합격 기준** | **표준 API 동작 테스트 통과** |
| **실행 환경** | 운영 환경 가능 |
| **비고** | 표준 준수 확인 |

#### Assertion 3.2: "클러스터가 '쿠버네티스답게' 동작하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "클러스터가 '쿠버네티스답게' 동작하는가?" |
| **테스트 방법** | `hydrophone run --wait` |
| **합격 기준** | **모든 기본 리소스(Pod, Service, ConfigMap, Secret, Job 등) 정상 동작 확인** |
| **검증 항목** | - Pod 생성/스케줄링 정상<br>- Service/Endpoint 동작 정상<br>- 기본 리소스 동작 정상<br>- kubelet/API server 핵심 동작 정상 |
| **비고** | "기본 자격증" 같은 느낌 |

## 합격 기준 정의

### 기본 합격 기준 (권장)

| 검증 항목 | 합격 기준 | 비고 |
|----------|----------|------|
| **Conformance (전체)** | 실패 0건 | 전체 Conformance 테스트 |
| **Conformance (Non-Disruptive)** | 실패 0건 | 운영 환경 기본 검증 |
| **Conformance (Quick)** | 실패 0건 | Slow 제외 빠른 검증 |

### 예외 처리

| 상황 | 처리 방법 |
|------|----------|
| **예외 승인 항목** | 사전 승인된 예외 항목은 합격 기준에서 제외 가능 |
| **Known Issue** | 알려진 이슈는 별도 문서화 및 개선 계획 필요 |
| **환경 제약** | 환경 제약으로 실행 불가 항목은 사전 정의 필요 |

**예외 승인 프로세스:**

1. 예외 항목 식별 및 문서화
2. 예외 승인 요청 (이유, 영향도, 개선 계획)
3. 승인 후 합격 기준에서 제외
4. 개선 계획 수립 및 추적

## 리포트 산출물 형태

### 표준화된 리포트 구조

```
hydrophone-results-YYYYMMDD/
├── e2e.log                          # 전체 테스트 실행 로그
├── junit_01.xml                     # JUnit XML 형식 결과
├── summary.md                        # 요약 리포트 (1~2페이지)
├── failed-tests.md                   # 실패 항목 상세
└── reproduction-guide.md             # 재현 방법 (명령어)
```

### 요약 리포트 예시 (summary.md)

```markdown
# Hydrophone Conformance Test 결과 요약

**실행 일시:** 2024-01-15 14:00:00 KST
**실행 모드:** Non-disruptive (Disruptive 제외)
**Kubernetes 버전:** v1.28.0
**Hydrophone 버전:** latest

## 전체 결과

| 항목 | 결과 |
|------|------|
| **전체 테스트** | XXXX개 |
| **성공** | XXXX개 |
| **실패** | 0개 |
| **성공률** | 100% |

## 합격 여부

✅ **합격** - 모든 Conformance 테스트 통과

## 다음 단계

- [ ] CAT 다음 단계 진행 (kube-bench 보안 검증)
- [ ] 성능/수용량 테스트 (kube-burner)
- [ ] 복원력 테스트 (LitmusChaos)
```

### 실패 항목 리포트 예시 (failed-tests.md)

```markdown
# Hydrophone 실패 항목 상세

## 실패 항목 목록

없음 (모든 테스트 통과)

## 재현 방법

```bash
# 전체 테스트 재현
hydrophone run --wait

# 특정 테스트만 재현 (예시)
hydrophone run --focus "\[Conformance\].*Service" --wait
```

## 조치 가이드

불필요 (실패 항목 없음)
```

## 결과 분석 방법

### e2e.log 분석

```bash
# 전체 로그 확인
cat e2e.log

# 실패 항목 확인
grep -i "fail" e2e.log

# 성공 항목 확인
grep -i "pass" e2e.log

# 테스트 통계
total=$(grep -c "Test:" e2e.log)
passed=$(grep -ic "PASS" e2e.log)
failed=$(grep -ic "FAIL" e2e.log)
echo "Total: $total, Passed: $passed, Failed: $failed"
```

### junit_01.xml 분석

```bash
# XML 형식 확인
xmllint --format junit_01.xml

# 실패한 테스트 확인
grep -i "failure" junit_01.xml

# 테스트 통계 (XML 파서 사용)
# 예: python, jq 등으로 파싱
```

## CAT 전체 흐름에서의 위치

### CAT 단계별 검증 질문

| 단계 | 카테고리 | 검증 질문(Assertion) | 도구 | 합격 기준 |
|------|---------|---------------------|------|----------|
| **1** | **Conformance/Config** | "클러스터가 공식 Conformance를 만족하는가?" | **Hydrophone** | **Conformance 100% 통과** |
| 2 | Security | "보안 설정이 CIS 기준을 만족하는가?" | kube-bench | High/Critical 0건 |
| 3 | Performance/Scale | "성능이 요구 수준인가?" | kube-burner | p95 API latency < X ms |
| 4 | Resilience | "장애 복구가 요구 시간 내인가?" | LitmusChaos | RTO < X분 |
| 5 | Automation | "검증이 자동화되었는가?" | CI/CD | 자동 실행 및 리포트 생성 |

### Gate 역할

```bash
# CAT 1단계: Hydrophone Conformance 검증
hydrophone run --skip "\[Disruptive\]" --wait

if [ ! -f "e2e.log" ] || [ ! -f "junit_01.xml" ]; then
  echo "❌ 결과 파일 생성 실패"
  exit 1
fi

fail_count=$(grep -ic "fail" e2e.log || echo "0")

if [ "$fail_count" -gt 0 ]; then
  echo "❌ CAT 1단계 실패: Hydrophone Conformance 검증 실패"
  exit 1
fi

echo "✅ CAT 1단계 통과: Hydrophone Conformance 검증 성공"
# → 다음 단계 진행 (kube-bench, kube-burner, LitmusChaos)
```

## 관련 문서

- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 Hydrophone 활용
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
