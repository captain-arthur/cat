# Workflow

Chaos Mesh Workflow를 사용하여 여러 실험을 직렬/병렬로 구성하는 방법을 설명합니다.

## Workflow란?

Workflow는 여러 Chaos 실험을 단계별로 구성하여 복합 실험을 실행하는 기능입니다.

### 주요 특징

- **직렬 실행**: 실험을 순차적으로 실행
- **병렬 실행**: 여러 실험을 동시에 실행
- **조건 분기**: 조건에 따라 다음 단계 분기
- **상태 확인**: 상태 확인 후 다음 단계 진행

## Workflow 기본 구조

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: workflow-example
  namespace: default
spec:
  entry: entry-step
  templates:
    - name: entry-step
      templateType: Serial
      deadline: 1h
      children:
        - pod-kill-step
        - network-delay-step
```

## Workflow 노드 타입

### 1. Serial (직렬 실행)

여러 단계를 순차적으로 실행합니다.

```yaml
- name: serial-step
  templateType: Serial
  deadline: 1h
  children:
    - pod-kill-step
    - network-delay-step
    - io-chaos-step
```

### 2. Parallel (병렬 실행)

여러 단계를 동시에 실행합니다.

```yaml
- name: parallel-step
  templateType: Parallel
  deadline: 30m
  children:
    - cpu-stress-step
    - memory-stress-step
```

### 3. Suspend (일시 정지)

Workflow를 일시 정지합니다.

```yaml
- name: suspend-step
  templateType: Suspend
  duration: 5m
```

### 4. Task (실험 실행)

실제 Chaos 실험을 실행합니다.

```yaml
- name: pod-kill-step
  templateType: PodChaos
  deadline: 10m
  podChaos:
    action: pod-kill
    mode: one
    duration: "60s"
    selector:
      namespaces:
        - default
      labelSelectors:
        app: test-app
```

### 5. Conditional Branch (조건 분기)

조건에 따라 다음 단계를 분기합니다.

```yaml
- name: conditional-step
  templateType: Serial
  deadline: 1h
  conditionalBranches:
    - target: success-step
      expression: "{{status.pod-kill-step.status}} == 'Success'"
    - target: failure-step
      expression: "{{status.pod-kill-step.status}} != 'Success'"
```

### 6. StatusCheck (상태 확인)

Pod 상태를 확인하고 다음 단계를 진행합니다.

```yaml
- name: status-check-step
  templateType: StatusCheck
  deadline: 5m
  statusCheck:
    mode: one
    selector:
      namespaces:
        - default
      labelSelectors:
        app: test-app
    statusCheck:
      - type: "kubernetes"
        target:
          kind: "Pod"
          apiVersion: "v1"
        state: "Running"
```

## 실전 예시

### 예시 1: 순차 실행

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: sequential-workflow
  namespace: default
spec:
  entry: entry-step
  templates:
    - name: entry-step
      templateType: Serial
      deadline: 1h
      children:
        - pod-kill-step
        - network-delay-step
        - cpu-stress-step

    - name: pod-kill-step
      templateType: PodChaos
      deadline: 10m
      podChaos:
        action: pod-kill
        mode: one
        duration: "60s"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app

    - name: network-delay-step
      templateType: NetworkChaos
      deadline: 10m
      networkChaos:
        action: delay
        mode: one
        duration: "5m"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app
        delay:
          latency: "100ms"

    - name: cpu-stress-step
      templateType: StressChaos
      deadline: 10m
      stressChaos:
        mode: one
        duration: "10m"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app
        stressors:
          cpu:
            workers: 4
            load: 80
```

### 예시 2: 병렬 실행

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: parallel-workflow
  namespace: default
spec:
  entry: entry-step
  templates:
    - name: entry-step
      templateType: Parallel
      deadline: 30m
      children:
        - cpu-stress-step
        - memory-stress-step
        - network-delay-step

    - name: cpu-stress-step
      templateType: StressChaos
      deadline: 30m
      stressChaos:
        mode: one
        duration: "30m"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app
        stressors:
          cpu:
            workers: 4
            load: 80

    - name: memory-stress-step
      templateType: StressChaos
      deadline: 30m
      stressChaos:
        mode: one
        duration: "30m"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app
        stressors:
          memory:
            workers: 4
            size: "256MB"

    - name: network-delay-step
      templateType: NetworkChaos
      deadline: 30m
      networkChaos:
        action: delay
        mode: one
        duration: "30m"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app
        delay:
          latency: "100ms"
```

### 예시 3: 조건 분기

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: conditional-workflow
  namespace: default
spec:
  entry: entry-step
  templates:
    - name: entry-step
      templateType: Serial
      deadline: 1h
      children:
        - pod-kill-step

    - name: pod-kill-step
      templateType: PodChaos
      deadline: 10m
      podChaos:
        action: pod-kill
        mode: one
        duration: "60s"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app

    - name: conditional-step
      templateType: Serial
      deadline: 1h
      conditionalBranches:
        - target: success-step
          expression: "{{status.pod-kill-step.status}} == 'Success'"
        - target: failure-step
          expression: "{{status.pod-kill-step-step.status}} != 'Success'"

    - name: success-step
      templateType: Suspend
      duration: 1m

    - name: failure-step
      templateType: NetworkChaos
      deadline: 10m
      networkChaos:
        action: delay
        mode: one
        duration: "5m"
        selector:
          namespaces:
            - default
          labelSelectors:
            app: test-app
        delay:
          latency: "100ms"
```

## Workflow 실행

```bash
# Workflow 생성
kubectl apply -f workflow.yaml

# Workflow 상태 확인
kubectl get workflow workflow-example -n default

# Workflow 상세 확인
kubectl describe workflow workflow-example -n default

# Workflow 삭제
kubectl delete workflow workflow-example -n default
```

## Workflow 상태

| 상태 | 설명 |
|------|------|
| `Running` | 실행 중 |
| `Succeeded` | 성공적으로 완료 |
| `Failed` | 실패 |
| `Suspended` | 일시 정지됨 |

## 관련 문서

- [04-실험-정의.md](./04-실험-정의.md) - Chaos Experiment 정의 방법
- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 활용
