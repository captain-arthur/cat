# Chaos Mesh 설치 및 사용법

Chaos Mesh를 설치하고 실행하여 결과를 확인하는 전체 워크플로우를 설명합니다.

## 설치

### Helm Chart로 설치 (권장)

```bash
# Helm repository 추가
helm repo add chaos-mesh https://charts.chaos-mesh.org
helm repo update

# Chaos Mesh 설치
helm install chaos-mesh chaos-mesh/chaos-mesh \
  --namespace=chaos-mesh \
  --create-namespace \
  --version=2.7.2

# 설치 확인
kubectl get pods -n chaos-mesh
```

### 설치 확인

```bash
# Pod 상태 확인
kubectl get pods -n chaos-mesh

# CRD 확인
kubectl get crd | grep chaos-mesh

# Dashboard Service 확인
kubectl get svc -n chaos-mesh chaos-dashboard
```

**예상 출력:**

```
NAME                                        READY   STATUS    RESTARTS   AGE
chaos-controller-manager-xxx               1/1     Running   0          1m
chaos-daemon-xxx                           1/1     Running   0          1m
chaos-daemon-yyy                           1/1     Running   0          1m
chaos-dashboard-xxx                        1/1     Running   0          1m
```

## 기본 워크플로우

### 1. Dashboard 접근

```bash
# Port Forward로 Dashboard 접근
kubectl port-forward -n chaos-mesh svc/chaos-dashboard 2333:2333

# 브라우저에서 접근
# http://localhost:2333
```

### 2. Chaos Experiment 생성

#### 예시: Pod Kill 실험

**pod-kill.yaml:**

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: pod-kill-example
  namespace: default
spec:
  action: pod-kill
  mode: one
  duration: "30s"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
```

**실험 생성:**

```bash
# CRD 생성
kubectl apply -f pod-kill.yaml

# 실험 상태 확인
kubectl get podchaos pod-kill-example -n default

# 실험 상세 확인
kubectl describe podchaos pod-kill-example -n default
```

### 3. 실험 상태 확인

**kubectl 명령어:**

```bash
# PodChaos 상태 확인
kubectl get podchaos -n default

# NetworkChaos 상태 확인
kubectl get networkchaos -n default

# 모든 Chaos 실험 확인
kubectl get chaos -A

# 실험 상세 확인
kubectl describe podchaos pod-kill-example -n default
```

**Dashboard에서 확인:**

- Dashboard UI에서 실험 상태, 로그, 이벤트 확인 가능
- 실시간 모니터링 및 결과 확인

### 4. 실험 삭제

```bash
# 실험 삭제 (자동 복구)
kubectl delete podchaos pod-kill-example -n default

# 또는 YAML 파일로 삭제
kubectl delete -f pod-kill.yaml
```

**참고:** 실험 삭제 시 Chaos Mesh가 자동으로 장애를 복구합니다.

## 실전 예시

### 예시 1: Pod Kill 실험

```bash
# 1. 실험 파일 작성
cat > pod-kill.yaml <<EOF
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: pod-kill-test
  namespace: default
spec:
  action: pod-kill
  mode: one
  duration: "60s"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
EOF

# 2. 실험 생성
kubectl apply -f pod-kill.yaml

# 3. 실험 상태 확인
kubectl get podchaos pod-kill-test -n default

# 4. Pod 상태 확인
kubectl get pods -l app=test-app -n default

# 5. 실험 종료 (자동 복구)
kubectl delete podchaos pod-kill-test -n default
```

### 예시 2: Network Delay 실험

```bash
# 1. 실험 파일 작성
cat > network-delay.yaml <<EOF
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-delay-test
  namespace: default
spec:
  action: delay
  mode: one
  duration: "5m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  delay:
    latency: "100ms"
    correlation: "100"
    jitter: "10ms"
EOF

# 2. 실험 생성
kubectl apply -f network-delay.yaml

# 3. 실험 상태 확인
kubectl get networkchaos network-delay-test -n default

# 4. 실험 종료 (자동 복구)
kubectl delete networkchaos network-delay-test -n default
```

### 예시 3: CPU Stress 실험

```bash
# 1. 실험 파일 작성
cat > cpu-stress.yaml <<EOF
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: cpu-stress-test
  namespace: default
spec:
  mode: one
  duration: "10m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  stressors:
    cpu:
      workers: 4
      load: 80
EOF

# 2. 실험 생성
kubectl apply -f cpu-stress.yaml

# 3. 실험 상태 확인
kubectl get stresschaos cpu-stress-test -n default

# 4. 실험 종료 (자동 복구)
kubectl delete stresschaos cpu-stress-test -n default
```

## 고급 사용법

### 실험 일시 정지/재개

```bash
# 실험 일시 정지
kubectl annotate podchaos pod-kill-test -n default \
  chaos-mesh.org/pause=true

# 실험 재개
kubectl annotate podchaos pod-kill-test -n default \
  chaos-mesh.org/pause-

# 또는 직접 수정
kubectl patch podchaos pod-kill-test -n default \
  --type merge -p '{"spec":{"duration":"0s"}}'
```

### 실험 모드 변경

| 모드 | 설명 |
|------|------|
| `one` | 하나의 Pod만 대상 |
| `all` | 모든 Pod 대상 |
| `fixed` | 지정된 개수만큼 대상 |
| `fixed-percent` | 지정된 비율만큼 대상 |
| `random-max-percent` | 랜덤하게 최대 비율까지 대상 |

### 네임스페이스 필터링

```yaml
spec:
  selector:
    namespaces:
      - default
      - production
    labelSelectors:
      app: test-app
    annotationSelectors:
      chaos-mesh.org/enable: "true"
```

## 문제 해결

### 일반적인 문제

#### 1. Chaos Daemon이 실행되지 않음

```bash
# Pod 상태 확인
kubectl get pods -n chaos-mesh | grep chaos-daemon

# Pod 로그 확인
kubectl logs -n chaos-mesh <chaos-daemon-pod-name>

# DaemonSet 확인
kubectl get daemonset -n chaos-mesh
```

#### 2. 실험이 실행되지 않음

```bash
# CRD 상태 확인
kubectl get crd | grep chaos-mesh

# 실험 이벤트 확인
kubectl describe podchaos <experiment-name> -n <namespace>

# Controller Manager 로그 확인
kubectl logs -n chaos-mesh -l app.kubernetes.io/component=controller-manager
```

#### 3. 권한 오류

```bash
# RBAC 확인
kubectl auth can-i create podchaos --all-namespaces

# ServiceAccount 확인
kubectl get sa -n chaos-mesh

# ClusterRole 확인
kubectl get clusterrole | grep chaos-mesh
```

#### 4. Dashboard 접근 불가

```bash
# Dashboard Pod 상태 확인
kubectl get pods -n chaos-mesh | grep dashboard

# Dashboard Service 확인
kubectl get svc -n chaos-mesh chaos-dashboard

# Port Forward 재시도
kubectl port-forward -n chaos-mesh svc/chaos-dashboard 2333:2333
```

## 관련 문서

- [04-실험-정의.md](./04-실험-정의.md) - Chaos Experiment 정의 상세 가이드
- [05-워크플로우.md](./05-워크플로우.md) - Workflow 사용 방법
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
