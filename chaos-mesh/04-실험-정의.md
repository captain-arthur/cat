# 실험(Experiment) 정의

Chaos Mesh에서 Chaos Experiment를 정의하는 방법을 상세히 설명합니다.

## Chaos Experiment 기본 구조

Chaos Mesh는 Kubernetes CRD로 실험을 정의합니다. 각 실험 유형별로 CRD가 존재합니다.

### 공통 구조

모든 Chaos Experiment CRD는 다음과 같은 공통 구조를 가집니다:

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: <ChaosType>
metadata:
  name: <experiment-name>
  namespace: <namespace>
spec:
  mode: <mode>
  duration: <duration>
  selector:
    namespaces:
      - <namespace>
    labelSelectors:
      <label-key>: <label-value>
  # 실험 유형별 특정 설정
```

### 주요 필드

| 필드 | 설명 | 필수 여부 |
|------|------|----------|
| `mode` | 실험 모드 (`one`, `all`, `fixed`, `fixed-percent`, `random-max-percent`) | 필수 |
| `duration` | 실험 지속 시간 (예: "30s", "5m") | 선택 (무한 지속 가능) |
| `selector` | 대상 Pod 선택 (namespaces, labelSelectors 등) | 필수 |
| 실험 유형별 설정 | 각 Chaos 타입별 특정 설정 | 실험 유형에 따라 다름 |

## 실험 유형별 정의

### 1. PodChaos (Pod 장애)

Pod 관련 장애를 시뮬레이션합니다.

#### Pod Kill

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: pod-kill-example
  namespace: default
spec:
  action: pod-kill
  mode: one
  duration: "30s"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
```

#### Container Kill

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: PodChaos
metadata:
  name: container-kill-example
  namespace: default
spec:
  action: container-kill
  mode: one
  duration: "60s"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
```

### 2. NetworkChaos (네트워크 장애)

네트워크 관련 장애를 시뮬레이션합니다.

#### Network Delay

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-delay-example
  namespace: default
spec:
  action: delay
  mode: one
  duration: "5m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  delay:
    latency: "100ms"
    correlation: "100"
    jitter: "10ms"
```

#### Network Loss

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-loss-example
  namespace: default
spec:
  action: loss
  mode: one
  duration: "10m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  loss:
    loss: "20%"
    correlation: "100"
```

#### Network Partition

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-partition-example
  namespace: default
spec:
  action: partition
  mode: one
  duration: "5m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  direction: both
  target:
    selector:
      namespaces:
        - default
      labelSelectors:
        app: other-app
```

### 3. IOChaos (I/O 장애)

디스크 I/O 관련 장애를 시뮬레이션합니다.

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: IOChaos
metadata:
  name: io-chaos-example
  namespace: default
spec:
  action: latency
  mode: one
  duration: "10m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  volumePath: /var/run
  path: /var/run/**/*
  delay: "100ms"
  percent: 100
  methods:
    - READ
    - WRITE
```

### 4. StressChaos (리소스 스트레스)

CPU/메모리 부하를 주입합니다.

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: cpu-stress-example
  namespace: default
spec:
  mode: one
  duration: "10m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  stressors:
    cpu:
      workers: 4
      load: 80
    memory:
      workers: 4
      size: "256MB"
```

### 5. TimeChaos (시간 장애)

시간 조작을 통한 장애를 시뮬레이션합니다.

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: TimeChaos
metadata:
  name: time-chaos-example
  namespace: default
spec:
  mode: one
  duration: "5m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  timeOffset: "-1h"
```

### 6. DNSChaos (DNS 장애)

DNS 쿼리 관련 장애를 시뮬레이션합니다.

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: DNSChaos
metadata:
  name: dns-chaos-example
  namespace: default
spec:
  action: error
  mode: one
  duration: "10m"
  selector:
    namespaces:
      - default
    labelSelectors:
      app: test-app
  patterns:
    - "*.example.com"
```

## Selector (대상 선택)

실험 대상을 선택하는 방법입니다.

### Namespace 선택

```yaml
selector:
  namespaces:
    - default
    - production
```

### Label Selector

```yaml
selector:
  labelSelectors:
    app: test-app
    env: production
```

### Annotation Selector

```yaml
selector:
  annotationSelectors:
    chaos-mesh.org/enable: "true"
```

### Pods 선택

```yaml
selector:
  pods:
    default:
      - test-pod-1
      - test-pod-2
```

## Mode (실험 모드)

| 모드 | 설명 | 예시 |
|------|------|------|
| `one` | 하나의 Pod만 대상 | `mode: one` |
| `all` | 모든 Pod 대상 | `mode: all` |
| `fixed` | 지정된 개수만큼 대상 | `mode: fixed` + `value: 2` |
| `fixed-percent` | 지정된 비율만큼 대상 | `mode: fixed-percent` + `value: "50"` |
| `random-max-percent` | 랜덤하게 최대 비율까지 대상 | `mode: random-max-percent` + `value: "30"` |

## Duration (실험 지속 시간)

실험 지속 시간을 정의합니다.

```yaml
duration: "30s"    # 30초
duration: "5m"     # 5분
duration: "1h"     # 1시간
```

**참고:** `duration`을 생략하면 실험을 수동으로 삭제할 때까지 지속됩니다.

## 실험 상태 확인

```bash
# 실험 상태 확인
kubectl get podchaos -n default

# 실험 상세 확인
kubectl describe podchaos pod-kill-example -n default

# Status 확인
kubectl get podchaos pod-kill-example -n default -o jsonpath='{.status}'
```

## 실험 일시 정지/재개

```bash
# 실험 일시 정지
kubectl annotate podchaos pod-kill-example -n default \
  chaos-mesh.org/pause=true

# 실험 재개
kubectl annotate podchaos pod-kill-example -n default \
  chaos-mesh.org/pause-
```

## 관련 문서

- [03-설치및사용법.md](./03-설치및사용법.md) - 설치부터 실행까지 기본 워크플로우
- [05-워크플로우.md](./05-워크플로우.md) - Workflow 사용 방법
- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 활용
