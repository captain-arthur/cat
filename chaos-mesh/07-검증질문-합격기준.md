# 검증 질문(Assertion) 및 합격 기준

Chaos Mesh를 사용하여 검증할 수 있는 **검증 질문(Assertion)**과 **합격 기준**을 정의합니다.

## 검증 질문(Assertion) 정의 원칙

### 핵심 원칙

**"도구"가 아니라 "검증 질문(Assertion)"으로 카테고리를 고정**

- 도구는 경계가 모호하다
- 같은 도구라도 질문이 다르면 다른 카테고리에 넣어도 된다
- 필요하다면 "Primary 카테고리 1개 + Secondary 태그"로 운영

### "그래서 우리는 뭘 통과하면 이 클러스터를 운영 승인할 수 있는가?"

- **기준(Policy)**: 수치/조건으로 명확히 정의
- **절차(Procedure)**: 검증 실행 방법
- **증거(Report)**: 결과 리포트 산출물

## Chaos Mesh 관련 검증 질문(Assertion)

### 1. Pod 복원력 검증

#### Assertion 1.1: "Pod가 죽었을 때 자동으로 복구되는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "Pod가 죽었을 때 자동으로 복구되는가?" |
| **테스트 방법** | PodChaos (pod-kill) → Pod 상태 확인 |
| **합격 기준** | **Pod 삭제 후 60초 이내에 "Running" 상태로 복구** |
| **실행 환경** | 테스트/운영 환경 (비파괴적) |
| **실행 시간** | 1-2분 |
| **비고** | **고가용성 확인 필수 항목** |

**실행 명령어:**

```bash
kubectl apply -f pod-kill.yaml
```

**합격 판단:**

```bash
# 실험 상태 확인
STATUS=$(kubectl get podchaos pod-kill-example -n default -o jsonpath='{.status.experiment.phase}')
POD_STATUS=$(kubectl get pods -l app=test-app -n default -o jsonpath='{.items[0].status.phase}')

if [ "$STATUS" != "Running" ] && [ "$STATUS" != "Finished" ]; then
  echo "❌ Pod 자동 복구 검증 실패: 운영 승인 불가"
  exit 1
fi

if [ "$POD_STATUS" != "Running" ]; then
  echo "❌ Pod 자동 복구 검증 실패: Pod 상태가 Running이 아님"
  exit 1
fi
```

### 2. 네트워크 복원력 검증

#### Assertion 2.1: "네트워크 지연 상황에서도 서비스가 정상 응답하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "네트워크 지연 상황에서도 서비스가 정상 응답하는가?" |
| **테스트 방법** | NetworkChaos (delay) → HTTP 응답 확인 |
| **합격 기준** | **네트워크 지연 주입 후 HTTP 200 응답 유지 (응답 시간 < 5초)** |
| **실행 환경** | 테스트/운영 환경 |
| **비고** | **네트워크 복원력 확인** |

### 3. 리소스 복원력 검증

#### Assertion 3.1: "리소스 부하 상황에서도 서비스가 정상 동작하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "리소스 부하 상황에서도 서비스가 정상 동작하는가?" |
| **테스트 방법** | StressChaos (CPU/Memory) → 서비스 응답 확인 |
| **합격 기준** | **CPU/메모리 부하 주입 후 서비스가 정상 응답 유지** |
| **실행 환경** | 테스트 환경 |
| **비고** | **리소스 복원력 확인** |

## 합격 기준 정의

### 기본 합격 기준 (권장)

| 검증 항목 | 합격 기준 | 비고 |
|----------|----------|------|
| **Pod 자동 복구** | Pod 삭제 후 60초 이내에 "Running" 상태로 복구 | 고가용성 확인 |
| **네트워크 복원력** | 네트워크 지연 후 HTTP 200 응답 유지 (응답 시간 < 5초) | 네트워크 복원력 확인 |
| **리소스 복원력** | CPU/메모리 부하 후 서비스가 정상 응답 유지 | 리소스 복원력 확인 |

### 실험 상태 기반 합격 기준

| 실험 상태 | 의미 | 합격 여부 |
|----------|------|----------|
| `phase: "Running"` | 실험 실행 중 | ✅ 진행 중 |
| `phase: "Finished"` | 실험 완료 (성공) | ✅ 합격 |
| `phase: "Failed"` | 실험 실패 | ❌ 불합격 |
| `phase: "Paused"` | 실험 일시 정지 | ⚠️ 확인 필요 |

## 예외 처리

| 상황 | 처리 방법 |
|------|----------|
| **예외 승인 항목** | 사전 승인된 예외 항목은 합격 기준에서 제외 가능 |
| **Known Issue** | 알려진 이슈는 별도 문서화 및 개선 계획 필요 |
| **환경 제약** | 환경 제약으로 실행 불가 항목은 사전 정의 필요 |

## CAT 전체 흐름에서의 위치

### CAT 단계별 검증 질문

| 단계 | 카테고리 | 검증 질문(Assertion) | 도구 | 합격 기준 |
|------|---------|---------------------|------|----------|
| 1 | Conformance/Config | "클러스터가 공식 Conformance를 만족하는가?" | Sonobuoy | Non-disruptive Conformance 100% 통과 |
| 2 | Security | "보안 설정이 CIS 기준을 만족하는가?" | kube-bench | High/Critical 0건 |
| 3 | Performance/Scale | "성능이 요구 수준인가?" | kube-burner | p95 API latency < X ms |
| **4** | **Resilience/Fault Tolerance** | **"장애 상황에서도 정상 동작을 유지하는가?"** | **Chaos Mesh** | **실험 완료 (phase: Finished)** |
| 5 | Automation | "검증이 자동화되었는가?" | CI/CD | 자동 실행 및 리포트 생성 |

### Gate 역할

```bash
# CAT 4단계: Chaos Mesh 복원력 검증
kubectl apply -f pod-kill.yaml

# 실험 상태 확인
STATUS=$(kubectl get podchaos pod-kill-example -n default -o jsonpath='{.status.experiment.phase}')

if [ "$STATUS" != "Running" ] && [ "$STATUS" != "Finished" ]; then
  echo "❌ CAT 4단계 실패: Chaos Mesh 복원력 검증 실패"
  exit 1
fi

echo "✅ CAT 4단계 통과: Chaos Mesh 복원력 검증 성공"
# → 다음 단계 진행 (리포트/자동화)
```

## 관련 문서

- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 Chaos Mesh 활용
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
