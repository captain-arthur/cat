# Sonobuoy 실무 체크리스트

Sonobuoy를 실무에 적용할 때 확인해야 할 사항들을 정리합니다.

## 실행 전 체크리스트

### 1. 환경 준비

| 항목 | 확인 사항 | 확인 방법 |
|------|----------|----------|
| **Kubernetes 버전** | v1.17 이상 지원 여부 확인 | `kubectl version --short` |
| **Sonobuoy 버전** | 클러스터 버전과 호환 여부 확인 | `sonobuoy version` |
| **권한** | cluster-admin 권한 보유 여부 확인 | `kubectl auth can-i create pods --all-namespaces` |
| **리소스** | 클러스터에 충분한 리소스 여부 확인 | `kubectl top nodes` |
| **네트워크** | 외부 레지스트리 접근 가능 여부 확인 | `curl -I https://registry.k8s.io` |

### 2. 실행 모드 선택

| 상황 | 권장 모드 | 이유 |
|------|----------|------|
| **운영 클러스터** | `non-disruptive-conformance` | 서비스 중단 최소화 |
| **테스트 클러스터** | `certified-conformance` | 전체 검증 가능 |
| **빠른 확인** | `quick` | 빠른 피드백 |
| **CNCF 인증 준비** | `certified-conformance` | 인증 기준 충족 |

### 3. Air-gapped 환경 (사설 레지스트리)

| 항목 | 확인 사항 | 대응 방법 |
|------|----------|----------|
| **이미지 미러링** | 필요한 이미지가 사설 레지스트리에 있는지 | 사전에 이미지 미러링 |
| **레지스트리 설정** | Sonobuoy가 사설 레지스트리를 사용하도록 설정 | `--e2e-repo-config` 옵션 사용 |
| **네트워크 접근** | 외부 레지스트리 접근 불가 여부 확인 | 사설 레지스트리 사용 설정 |

## 실행 중 체크리스트

### 1. 상태 모니터링

| 항목 | 확인 방법 | 비고 |
|------|----------|------|
| **실행 상태** | `sonobuoy status` | 정기적으로 확인 |
| **Pod 상태** | `kubectl get pods -n sonobuoy` | 정상 실행 중인지 확인 |
| **리소스 사용량** | `kubectl top pods -n sonobuoy` | 리소스 부족 확인 |
| **로그 확인** | `sonobuoy logs` | 오류 발생 여부 확인 |

### 2. 문제 발생 시 대응

| 문제 | 확인 사항 | 대응 방법 |
|------|----------|----------|
| **타임아웃** | 실행 시간이 너무 길어지는지 | `--timeout` 옵션 조정 |
| **Pod 실패** | 플러그인 Pod가 실패하는지 | `kubectl describe pod -n sonobuoy` |
| **리소스 부족** | 클러스터 리소스가 부족한지 | 노드 추가 또는 리소스 제한 조정 |
| **네트워크 오류** | 외부 레지스트리 접근 오류 | 네트워크 설정 확인 또는 사설 레지스트리 사용 |

## 실행 후 체크리스트

### 1. 결과 확인

| 항목 | 확인 방법 | 비고 |
|------|----------|------|
| **결과 다운로드** | `sonobuoy retrieve` | 결과 파일 다운로드 |
| **결과 분석** | `sonobuoy results <file>` | 성공/실패 항목 확인 |
| **로그 확인** | `sonobuoy logs` | 상세 로그 확인 |
| **합격 여부** | 실패 항목 0건 여부 확인 | 합격 기준 충족 확인 |

### 2. 리포트 생성

| 산출물 | 생성 방법 | 비고 |
|--------|----------|------|
| **원본 결과 파일** | `sonobuoy retrieve` | `results.tar.gz` 저장 |
| **요약 리포트** | `sonobuoy results` 출력 + 문서화 | Markdown 파일로 저장 |
| **실패 항목 상세** | 실패 항목 분석 및 문서화 | 조치 가이드 포함 |
| **재현 방법** | 명령어 및 매니페스트 문서화 | `reproduction-guide.md` |

### 3. 정리

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **리소스 정리** | `sonobuoy delete --wait` | 클러스터 리소스 정리 |
| **네임스페이스 확인** | `kubectl get ns sonobuoy` | 네임스페이스 삭제 확인 |
| **Pod 정리 확인** | `kubectl get pods -n sonobuoy` | 남은 Pod 없음 확인 |

## 운영 환경 적용 체크리스트

### 1. 안전성 확인

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **모드 선택** | `non-disruptive-conformance` 모드 사용 | 운영 환경 권장 |
| **Disruptive 테스트** | 파괴적 테스트 제외 확인 | 기본적으로 제외됨 |
| **워크로드 영향** | 기존 워크로드에 영향 없음 확인 | 모니터링 필요 |
| **실행 시간** | 서비스 시간대 고려 | 트래픽 낮은 시간대 실행 |

### 2. 권한 관리

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **cluster-admin 권한** | 실행 계정에 권한 부여 | RBAC 설정 확인 |
| **ServiceAccount** | 필요한 경우 ServiceAccount 생성 | 보안 강화 |
| **권한 범위** | 최소 권한 원칙 준수 | 가능하면 제한적 권한 |

### 3. 자동화 통합

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **CI/CD 통합** | 파이프라인에 Sonobuoy 단계 추가 | 자동 실행 |
| **Gate 설정** | 실패 시 배포 차단 설정 | 합격 기준 적용 |
| **리포트 저장** | 결과를 아티팩트 저장소에 저장 | 추적 가능하도록 |
| **알림 설정** | 실패 시 알림 발송 | 슬랙/이메일 등 |

## 문제 해결 체크리스트

### 1. 권한 오류

```bash
# 확인
kubectl auth can-i create pods --all-namespaces

# 해결 (필요 시)
kubectl create clusterrolebinding sonobuoy-cluster-admin \
  --clusterrole=cluster-admin \
  --serviceaccount=default:sonobuoy
```

### 2. 버전 호환성 문제

```bash
# Kubernetes 버전 확인
kubectl version --short

# Sonobuoy 버전 확인
sonobuoy version

# --skip-preflight 옵션 (주의 필요)
sonobuoy run --mode non-disruptive-conformance \
  --skip-preflight \
  --wait
```

### 3. 타임아웃 문제

```bash
# 타임아웃 증가 (2시간 → 3시간)
sonobuoy run --mode non-disruptive-conformance \
  --wait \
  --timeout 10800
```

### 4. 실행 중단된 테스트 정리

```bash
# 남아있는 리소스 확인
kubectl get pods -n sonobuoy

# 정리
sonobuoy delete --wait

# 강제 정리 (필요 시)
kubectl delete namespace sonobuoy --force
```

### 5. 이미지 풀 오류 (Air-gapped)

```bash
# 사설 레지스트리 설정
sonobuoy run --mode non-disruptive-conformance \
  --e2e-repo-config my-repo-config.yaml \
  --wait
```

## CAT 통합 체크리스트

### 1. 검증 질문(Assertion) 정의

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **검증 질문 명확화** | "클러스터가 공식 Conformance를 만족하는가?" | Assertion 정의 |
| **합격 기준 수립** | "Non-disruptive Conformance 100% 통과" | 수치/조건 명확화 |
| **예외 처리** | 예외 항목 및 승인 프로세스 정의 | 사전 정의 |

### 2. 기준(Policy) + 절차(Procedure) + 증거(Report)

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **기준 정의** | 합격 기준 문서화 | Policy 문서 |
| **절차 정의** | 실행 방법 문서화 | Procedure 문서 |
| **증거 관리** | 리포트 저장 및 추적 | Report 저장소 |

### 3. Gate 역할

| 항목 | 확인 사항 | 비고 |
|------|----------|------|
| **자동 Gate** | 실패 시 배포 차단 | CI/CD 설정 |
| **수동 검토** | 필요한 경우 수동 검토 | 예외 승인 |
| **다음 단계 연결** | CAT 다음 단계로 진행 | kube-bench, kube-burner 등 |

## 정기 점검 체크리스트

### 주기별 체크리스트

| 주기 | 항목 | 비고 |
|------|------|------|
| **클러스터 배포 시** | Sonobuoy 실행 및 합격 확인 | 인수 테스트 |
| **버전 업그레이드 시** | 업그레이드 전/후 Conformance 비교 | 호환성 확인 |
| **정기 점검 (월 1회)** | 정기적으로 Sonobuoy 실행 | 지속적 검증 |
| **보안 정책 변경 시** | 변경 후 Conformance 재검증 | 영향도 확인 |

## 관련 문서

- [04-기본사용법.md](./04-기본사용법.md) - 기본 사용법 및 문제 해결
- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 활용
- [09-CICD-통합.md](./09-CICD-통합.md) - CI/CD 통합 가이드
