# Sonobuoy 구성 요소

Sonobuoy는 다음 세 가지 주요 구성 요소로 이루어져 있습니다.

## 아키텍처 개요

```
┌─────────────────┐
│  Sonobuoy CLI   │  ← 사용자가 실행하는 명령어 도구
└────────┬────────┘
         │ kubectl/API
         ↓
┌─────────────────────────────────────────────┐
│         Kubernetes Cluster                  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Aggregator Pod (sonobuoy namespace)│  │
│  │   - 플러그인 관리                     │  │
│  │   - 결과 취합                         │  │
│  └─────────────┬────────────────────────┘  │
│                │                            │
│       ┌────────┴────────┐                  │
│       ↓                  ↓                  │
│  ┌─────────┐      ┌──────────────┐         │
│  │ E2E     │      │ Systemd Logs │         │
│  │ Plugin  │      │ Plugin       │         │
│  └─────────┘      └──────────────┘         │
│                                             │
│       (기타 커스텀 플러그인들)              │
└─────────────────────────────────────────────┘
```

## 구성 요소 상세

### 1. CLI 유틸리티

커맨드라인에서 실행하는 클라이언트 도구입니다.

| 명령어 | 기능 | 설명 |
|--------|------|------|
| `sonobuoy run` | 테스트 실행 | 클러스터에 Sonobuoy 실행 요청 |
| `sonobuoy status` | 상태 확인 | 현재 실행 중인 테스트 상태 확인 |
| `sonobuoy retrieve` | 결과 다운로드 | 테스트 결과 파일(tar.gz) 다운로드 |
| `sonobuoy results` | 결과 분석 | 결과 파일에서 성공/실패 항목 확인 |
| `sonobuoy logs` | 로그 확인 | Sonobuoy 실행 로그 확인 |
| `sonobuoy delete` | 리소스 정리 | Sonobuoy가 생성한 리소스 삭제 |

**설치 방법:**

```bash
# macOS (Homebrew)
brew install sonobuoy

# Linux
curl -LO https://github.com/vmware-tanzu/sonobuoy/releases/download/v0.57.3/sonobuoy_0.57.3_linux_amd64.tar.gz
tar xzf sonobuoy_0.57.3_linux_amd64.tar.gz
sudo mv sonobuoy /usr/local/bin/
```

### 2. Aggregator Pod

클러스터 내부에서 실행되는 핵심 컴포넌트입니다.

| 역할 | 설명 |
|------|------|
| **플러그인 관리** | 여러 플러그인의 실행을 조율하고 관리 |
| **결과 취합** | 플러그인별 결과를 수집하여 최종 리포트 생성 |
| **네임스페이스 관리** | `sonobuoy` 네임스페이스에서 실행되며, 플러그인 Pod들을 생성/관리 |
| **상태 추적** | 테스트 진행 상황을 추적하고 CLI에 상태 정보 제공 |

**특징:**
- `sonobuoy` 네임스페이스에 배포됨
- 여러 플러그인을 병렬/순차적으로 실행
- 플러그인별 결과를 취합하여 최종 결과 파일 생성

### 3. 플러그인(Plugins)

실제 검증 작업을 수행하는 모듈들입니다.

#### 기본 제공 플러그인

| 플러그인 | 기능 | 설명 |
|----------|------|------|
| **E2E Plugin** | Conformance 테스트 | Kubernetes E2E 테스트 실행 (conformance 포함) |
| **Systemd Logs Plugin** | 로그 수집 | 시스템 로그 수집 및 분석 |

#### 커스텀 플러그인

사용자가 직접 작성하여 추가할 수 있는 플러그인입니다.

**플러그인 타입:**

| 타입 | 설명 | 예시 |
|------|------|------|
| **Job Plugin** | 단일 Job으로 실행되는 플러그인 | 보안 스캔, 구성 검사 |
| **DaemonSet Plugin** | 각 노드에서 실행되는 플러그인 | 노드별 로그 수집, 노드 설정 검사 |

**커스텀 플러그인 예시:**
- CIS 벤치마크 검사 (kube-bench 통합)
- 스토리지/네트워크 특화 테스트
- 조직별 정책 검증

## 실행 흐름

```bash
# 1. 사용자가 CLI 명령 실행
sonobuoy run --mode non-disruptive-conformance

# 2. CLI가 Aggregator Pod 생성
kubectl apply -f <sonobuoy-manifest>

# 3. Aggregator Pod가 플러그인 실행
Aggregator → E2E Plugin Pod 생성
Aggregator → Systemd Logs Plugin DaemonSet 생성
...

# 4. 플러그인들이 테스트 수행 및 결과 수집
E2E Plugin → 테스트 실행 → 결과 수집
Systemd Logs → 로그 수집 → 결과 생성

# 5. Aggregator가 결과 취합
Aggregator → 플러그인 결과 취합 → 최종 리포트 생성

# 6. 사용자가 결과 다운로드
sonobuoy retrieve
sonobuoy results <result-file>
```

## 네임스페이스 구조

Sonobuoy는 `sonobuoy` 네임스페이스를 사용합니다:

```
sonobuoy/
├── sonobuoy (ServiceAccount)
├── sonobuoy-aggregator (Pod)          ← Aggregator
├── sonobuoy-e2e-job-xxxxx (Pod)       ← E2E 플러그인
└── sonobuoy-systemd-logs-xxxxx (Pod)  ← Systemd Logs 플러그인 (각 노드)
```

## 권한 요구사항

| 리소스 | 권한 | 필요 이유 |
|--------|------|----------|
| **Namespace** | 생성/삭제 | `sonobuoy` 네임스페이스 관리 |
| **Pod** | 생성/삭제/조회 | 플러그인 Pod 실행 |
| **Job/DaemonSet** | 생성/삭제 | 플러그인 실행 형태 |
| **API Server** | 접근 | Conformance 테스트 실행 |
| **Node** | 조회 | 노드 정보 수집 (일부 플러그인) |

일반적으로 **cluster-admin** 권한이 필요합니다.

## 관련 문서

- [03-실행모드.md](./03-실행모드.md) - 플러그인별 실행 모드
- [05-커스터마이징.md](./05-커스터마이징.md) - 커스텀 플러그인 작성
