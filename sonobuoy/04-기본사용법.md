# Sonobuoy 기본 사용법

Sonobuoy를 설치하고 실행하여 결과를 확인하는 전체 워크플로우를 설명합니다.

## 설치

### macOS

```bash
brew install sonobuoy
```

### Linux

```bash
# 최신 버전 확인: https://github.com/vmware-tanzu/sonobuoy/releases

# 다운로드 및 설치
VERSION=v0.57.3
curl -LO https://github.com/vmware-tanzu/sonobuoy/releases/download/${VERSION}/sonobuoy_${VERSION}_linux_amd64.tar.gz
tar xzf sonobuoy_${VERSION}_linux_amd64.tar.gz
sudo mv sonobuoy /usr/local/bin/
chmod +x /usr/local/bin/sonobuoy
```

### Windows

```powershell
# Chocolatey
choco install sonobuoy

# 또는 직접 다운로드
# https://github.com/vmware-tanzu/sonobuoy/releases
```

### 설치 확인

```bash
sonobuoy version
```

## 기본 워크플로우

### 1. 테스트 실행

```bash
# 기본 실행 (non-disruptive-conformance 모드, 완료까지 대기)
sonobuoy run --mode non-disruptive-conformance --wait
```

**옵션 설명:**

| 옵션 | 설명 | 필수 여부 |
|------|------|----------|
| `--mode` | 실행 모드 지정 (`quick`, `non-disruptive-conformance`, `certified-conformance`) | 선택 (기본값: non-disruptive-conformance) |
| `--wait` | 테스트 완료까지 대기 | 선택 (없으면 백그라운드 실행) |
| `--timeout` | 타임아웃 설정 (초) | 선택 |

**백그라운드 실행 (선택적):**

```bash
# 백그라운드로 실행
sonobuoy run --mode non-disruptive-conformance

# 이후 상태 확인
sonobuoy status
```

### 2. 상태 확인

실행 중인 테스트의 상태를 확인합니다:

```bash
sonobuoy status
```

**출력 예시:**

```
         PLUGIN             STATUS   RESULT   COUNT
         e2e                running           N/A
         systemd-logs       complete   passed     5
```

**상태 값:**

| 상태 | 의미 |
|------|------|
| `running` | 현재 실행 중 |
| `complete` | 완료됨 |
| `failed` | 실패 |

### 3. 결과 다운로드

테스트가 완료되면 결과 파일을 다운로드합니다:

```bash
# 결과 파일 다운로드 (자동으로 파일명 생성)
results=$(sonobuoy retrieve)
echo "결과 파일: $results"

# 또는 직접 파일명 지정
sonobuoy retrieve results.tar.gz
```

**다운로드되는 파일 구조:**

```
results.tar.gz
├── plugins/
│   ├── e2e/
│   │   ├── results/
│   │   └── e2e.log
│   └── systemd-logs/
│       └── results/
├── meta/
│   └── config.json
└── sonobuoy_results.yaml
```

### 4. 결과 분석

다운로드한 결과 파일을 분석합니다:

```bash
# 기본 결과 요약
sonobuoy results $results

# 또는
sonobuoy results results.tar.gz
```

**출력 예시:**

```
Plugin: e2e
Status: passed
Total: 4323
Passed: 4323
Failed: 0
```

### 5. 상세 로그 확인

특정 플러그인의 상세 로그를 확인합니다:

```bash
# 전체 로그
sonobuoy logs

# 특정 플러그인 로그
sonobuoy logs --plugin e2e

# 파일로 저장
sonobuoy logs > sonobuoy.log
```

### 6. 리소스 정리

테스트가 완료되면 클러스터 리소스를 정리합니다:

```bash
# 정리 (완료까지 대기)
sonobuoy delete --wait

# 또는 즉시 정리
sonobuoy delete
```

## 실전 예시: 전체 워크플로우

```bash
#!/bin/bash

# 1. 테스트 실행
echo "Sonobuoy 테스트 시작..."
sonobuoy run --mode non-disruptive-conformance --wait

# 2. 결과 다운로드
echo "결과 다운로드 중..."
results=$(sonobuoy retrieve)
echo "결과 파일: $results"

# 3. 결과 확인
echo "결과 분석 중..."
sonobuoy results $results

# 4. 로그 저장
echo "로그 저장 중..."
sonobuoy logs > sonobuoy-$(date +%Y%m%d-%H%M%S).log

# 5. 정리
echo "리소스 정리 중..."
sonobuoy delete --wait

echo "완료!"
```

## 고급 사용법

### 특정 테스트만 실행

```bash
# Conformance 태그만 실행
sonobuoy run --mode non-disruptive-conformance \
  --e2e-focus="\[Conformance\]" \
  --wait
```

### 특정 테스트 제외

```bash
# Slow 테스트 제외
sonobuoy run --mode non-disruptive-conformance \
  --e2e-skip="\[Slow\]" \
  --wait
```

### 타임아웃 설정

```bash
# 2시간 타임아웃
sonobuoy run --mode non-disruptive-conformance \
  --wait \
  --timeout 7200
```

### 네임스페이스 지정

```bash
# 특정 네임스페이스에 배포
sonobuoy run --mode non-disruptive-conformance \
  --sonobuoy-namespace my-sonobuoy \
  --wait
```

## 문제 해결

### 일반적인 문제

#### 1. 권한 오류

```bash
# cluster-admin 권한 확인
kubectl auth can-i create pods --all-namespaces

# 권한 부여 (필요 시)
kubectl create clusterrolebinding sonobuoy-cluster-admin \
  --clusterrole=cluster-admin \
  --serviceaccount=default:sonobuoy
```

#### 2. 타임아웃

```bash
# 타임아웃 증가
sonobuoy run --mode non-disruptive-conformance \
  --wait \
  --timeout 10800  # 3시간
```

#### 3. 실행 중단된 테스트 정리

```bash
# 남아있는 리소스 확인
kubectl get pods -n sonobuoy

# 강제 정리
sonobuoy delete --wait
kubectl delete namespace sonobuoy --force
```

#### 4. 버전 호환성

```bash
# Kubernetes 버전 확인
kubectl version --short

# Sonobuoy 버전 확인
sonobuoy version

# --skip-preflight 옵션 (주의 필요)
sonobuoy run --mode non-disruptive-conformance \
  --skip-preflight \
  --wait
```

## 관련 문서

- [03-실행모드.md](./03-실행모드.md) - 실행 모드 선택 가이드
- [05-커스터마이징.md](./05-커스터마이징.md) - 고급 옵션 및 커스터마이징
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
