# 실험(Experiment) 정의

Chaos Toolkit에서 Experiment 파일을 작성하는 방법을 상세히 설명합니다.

## Experiment 파일 구조

Experiment 파일은 JSON 또는 YAML 형식으로 작성할 수 있습니다.

### 기본 구조

```json
{
  "version": "1.0.0",
  "title": "실험 제목",
  "description": "실험 설명",
  "steady-state-hypothesis": {
    "title": "정상 상태 가설",
    "probes": []
  },
  "method": [],
  "rollbacks": []
}
```

### 주요 필드

| 필드 | 설명 | 필수 여부 |
|------|------|----------|
| `version` | Experiment 버전 | 선택 |
| `title` | 실험 제목 | 필수 |
| `description` | 실험 설명 | 선택 |
| `steady-state-hypothesis` | 정상 상태 가설 | 필수 |
| `method` | 실험 방법 (Actions) | 선택 |
| `rollbacks` | 복구 방법 | 선택 |

## Steady-State Hypothesis (정상 상태 가설)

실험 전/후 시스템의 정상 상태를 정의하고 검증합니다.

### 기본 구조

```json
{
  "steady-state-hypothesis": {
    "title": "정상 상태 확인",
    "probes": [
      {
        "type": "probe",
        "name": "probe-name",
        "provider": {},
        "tolerance": {}
      }
    ]
  }
}
```

### Probe 예시

#### Kubernetes Pod 상태 확인

```json
{
  "type": "probe",
  "name": "pod-exists",
  "provider": {
    "type": "python",
    "module": "chaosk8s.pod.probes",
    "func": "read_pods",
    "arguments": {
      "label_selector": "app=test-app",
      "ns": "default"
    }
  },
  "tolerance": {
    "type": "jsonpath",
    "path": "$.items[*].status.phase",
    "expect": [
      "Running"
    ]
  }
}
```

#### HTTP 상태 코드 확인

```json
{
  "type": "probe",
  "name": "http-status",
  "provider": {
    "type": "http",
    "url": "https://example.com/health",
    "method": "GET"
  },
  "tolerance": 200
}
```

### Tolerance (허용 오차)

Probe 결과에 대한 허용 범위를 정의합니다.

| Tolerance 타입 | 설명 | 예시 |
|---------------|------|------|
| `jsonpath` | JSONPath로 값 추출 후 비교 | `{"type": "jsonpath", "path": "$.status.phase", "expect": "Running"}` |
| `regex` | 정규식 매칭 | `{"type": "regex", "pattern": "Running"}` |
| `range` | 숫자 범위 비교 | `{"type": "range", "min": 0, "max": 100}` |
| `integer` | 정수 비교 | `{"type": "integer", "expect": 200}` |

## Method (실험 방법)

장애를 주입하는 Actions를 정의합니다.

### 기본 구조

```json
{
  "method": [
    {
      "type": "action",
      "name": "action-name",
      "provider": {},
      "pauses": {}
    }
  ]
}
```

### Action 예시

#### Kubernetes Pod 삭제

```json
{
  "type": "action",
  "name": "delete-pod",
  "provider": {
    "type": "python",
    "module": "chaosk8s.pod.actions",
    "func": "delete_pods",
    "arguments": {
      "label_selector": "app=test-app",
      "ns": "default"
    }
  },
  "pauses": {
    "after": 30
  }
}
```

#### HTTP 트래픽 증가

```json
{
  "type": "action",
  "name": "increase-traffic",
  "provider": {
    "type": "http",
    "url": "https://example.com/api",
    "method": "POST",
    "body": {
      "intensity": "high"
    }
  }
}
```

### Pauses (대기)

Action 실행 전/후 대기 시간을 설정합니다.

```json
{
  "pauses": {
    "before": 10,    // Action 실행 전 10초 대기
    "after": 30      // Action 실행 후 30초 대기
  }
}
```

## Rollback (복구)

실험 후 문제 발생 시 자동 복구하는 작업을 정의합니다.

### 기본 구조

```json
{
  "rollbacks": [
    {
      "type": "action",
      "name": "rollback-name",
      "provider": {}
    }
  ]
}
```

### Rollback 예시

#### Pod 재생성

```json
{
  "type": "action",
  "name": "restart-deployment",
  "provider": {
    "type": "python",
    "module": "chaosk8s.deployment.actions",
    "func": "restart_deployment",
    "arguments": {
      "name": "test-app",
      "ns": "default"
    }
  }
}
```

## 완전한 Experiment 예시

### Pod 삭제 후 자동 복구 테스트

```json
{
  "version": "1.0.0",
  "title": "Pod resilience test",
  "description": "Pod를 삭제했을 때 자동으로 복구되는지 테스트",
  "steady-state-hypothesis": {
    "title": "정상 상태 확인",
    "probes": [
      {
        "type": "probe",
        "name": "pod-exists-before",
        "provider": {
          "type": "python",
          "module": "chaosk8s.pod.probes",
          "func": "read_pods",
          "arguments": {
            "label_selector": "app=test-app",
            "ns": "default"
          }
        },
        "tolerance": {
          "type": "jsonpath",
          "path": "$.items[*].status.phase",
          "expect": [
            "Running"
          ]
        }
      }
    ]
  },
  "method": [
    {
      "type": "action",
      "name": "delete-pod",
      "provider": {
        "type": "python",
        "module": "chaosk8s.pod.actions",
        "func": "delete_pods",
        "arguments": {
          "label_selector": "app=test-app",
          "ns": "default",
          "rand": true
        }
      },
      "pauses": {
        "after": 60
      }
    },
    {
      "type": "probe",
      "name": "pod-exists-after",
      "provider": {
        "type": "python",
        "module": "chaosk8s.pod.probes",
        "func": "read_pods",
        "arguments": {
          "label_selector": "app=test-app",
          "ns": "default"
        }
      },
      "tolerance": {
        "type": "jsonpath",
        "path": "$.items[*].status.phase",
        "expect": [
          "Running"
        ]
      }
    }
  ],
  "rollbacks": []
}
```

## 실험 실행 흐름

```
1. Steady-State Hypothesis (실험 전)
   └─ Probe 실행 → 정상 상태 확인

2. Method 실행
   └─ Action 실행 → 장애 주입
   └─ Pause (선택적)
   └─ Probe 실행 (선택적) → 상태 확인

3. Steady-State Hypothesis (실험 후)
   └─ Probe 실행 → 정상 상태 유지 확인

4. Rollback (선택적)
   └─ Action 실행 → 복구
```

## 관련 문서

- [03-설치및사용법.md](./03-설치및사용법.md) - 설치부터 실행까지 기본 워크플로우
- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 활용
- [07-검증질문-합격기준.md](./07-검증질문-합격기준.md) - Steady-State Hypothesis 기반 통과/실패 기준
