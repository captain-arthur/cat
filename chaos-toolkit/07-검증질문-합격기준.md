# 검증 질문(Assertion) 및 합격 기준

Chaos Toolkit을 사용하여 검증할 수 있는 **검증 질문(Assertion)**과 **합격 기준**을 정의합니다.

## 검증 질문(Assertion) 정의 원칙

### 핵심 원칙

**"도구"가 아니라 "검증 질문(Assertion)"으로 카테고리를 고정**

- 도구는 경계가 모호하다
- 같은 도구라도 질문이 다르면 다른 카테고리에 넣어도 된다
- 필요하다면 "Primary 카테고리 1개 + Secondary 태그"로 운영

### "그래서 우리는 뭘 통과하면 이 클러스터를 운영 승인할 수 있는가?"

- **기준(Policy)**: 수치/조건으로 명확히 정의
- **절차(Procedure)**: 검증 실행 방법
- **증거(Report)**: 결과 리포트 산출물

## Chaos Toolkit 관련 검증 질문(Assertion)

### 1. Pod 복원력 검증

#### Assertion 1.1: "Pod가 죽었을 때 자동으로 복구되는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "Pod가 죽었을 때 자동으로 복구되는가?" |
| **테스트 방법** | Pod 삭제 → Steady-State Hypothesis 검증 (Pod 상태 "Running" 확인) |
| **합격 기준** | **Pod 삭제 후 60초 이내에 "Running" 상태로 복구** |
| **실행 환경** | 테스트/운영 환경 (비파괴적) |
| **실행 시간** | 1-2분 |
| **비고** | **고가용성 확인 필수 항목** |

**실행 명령어:**

```bash
chaos run pod-resilience.json --journal-path journal.json
```

**합격 판단:**

```bash
# Journal 파일에서 Steady-State Hypothesis 확인
STATUS=$(cat journal.json | jq -r '.status')
DEVIATED=$(cat journal.json | jq -r '.steady-state-hypothesis.deviated')

if [ "$STATUS" != "completed" ] || [ "$DEVIATED" = "true" ]; then
  echo "❌ Pod 자동 복구 검증 실패: 운영 승인 불가"
  exit 1
fi
```

#### Assertion 1.2: "Deployment가 Pod 장애 시 자동으로 복구하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "Deployment가 Pod 장애 시 자동으로 복구하는가?" |
| **테스트 방법** | Pod 삭제 → Deployment 복제본 수 확인 |
| **합격 기준** | **Pod 삭제 후 60초 이내에 복제본 수가 요구 값으로 복구** |
| **실행 환경** | 테스트/운영 환경 |
| **비고** | **고가용성 확인 필수 항목** |

### 2. 노드 장애 대응 검증

#### Assertion 2.1: "노드 장애 시 워크로드가 다른 노드로 이동하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "노드 장애 시 워크로드가 다른 노드로 이동하는가?" |
| **테스트 방법** | 노드 종료 → Pod 재스케줄링 확인 |
| **합격 기준** | **노드 장애 후 5분 이내에 Pod가 다른 노드에 재스케줄링됨** |
| **실행 환경** | 테스트 환경 (파괴적) |
| **비고** | **고가용성 확인 중요 항목** |

**주의사항:**
- 노드 종료는 파괴적 작업이므로 테스트 환경에서만 실행
- 운영 환경에서는 시뮬레이션 방식 권장

### 3. 네트워크 복원력 검증

#### Assertion 3.1: "네트워크 지연 상황에서도 서비스가 정상 응답하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "네트워크 지연 상황에서도 서비스가 정상 응답하는가?" |
| **테스트 방법** | 네트워크 지연 주입 → HTTP 응답 확인 |
| **합격 기준** | **네트워크 지연 주입 후 HTTP 200 응답 유지 (응답 시간 < 5초)** |
| **실행 환경** | 테스트/운영 환경 |
| **비고** | **네트워크 복원력 확인** |

#### Assertion 3.2: "네트워크 분할 상황에서도 서비스가 정상 동작하는가?"

| 항목 | 내용 |
|------|------|
| **검증 질문** | "네트워크 분할 상황에서도 서비스가 정상 동작하는가?" |
| **테스트 방법** | 네트워크 분할 시뮬레이션 → 서비스 응답 확인 |
| **합격 기준** | **네트워크 분할 후 서비스가 정상 응답 유지** |
| **실행 환경** | 테스트 환경 (주의 필요) |
| **비고** | **네트워크 복원력 확인 (고급)** |

## 합격 기준 정의

### 기본 합격 기준 (권장)

| 검증 항목 | 합격 기준 | 비고 |
|----------|----------|------|
| **Pod 자동 복구** | Pod 삭제 후 60초 이내에 "Running" 상태로 복구 | 고가용성 확인 |
| **노드 장애 대응** | 노드 장애 후 5분 이내에 Pod가 다른 노드에 재스케줄링됨 | 고가용성 확인 |
| **네트워크 복원력** | 네트워크 지연 후 HTTP 200 응답 유지 (응답 시간 < 5초) | 네트워크 복원력 확인 |

### Steady-State Hypothesis 기반 합격 기준

| Steady-State Hypothesis 상태 | 의미 | 합격 여부 |
|------------------------------|------|----------|
| `deviated: false` | 실험 전/후 정상 상태 유지 | ✅ 합격 |
| `deviated: true` | 실험 후 정상 상태 위반 | ❌ 불합격 |
| `status: "completed"` | 실험 완료 (성공) | ✅ 합격 |
| `status: "failed"` | Steady-State Hypothesis 실패 | ❌ 불합격 |
| `status: "aborted"` | 실험 중단 | ⚠️ 확인 필요 |

## 예외 처리

| 상황 | 처리 방법 |
|------|----------|
| **예외 승인 항목** | 사전 승인된 예외 항목은 합격 기준에서 제외 가능 |
| **Known Issue** | 알려진 이슈는 별도 문서화 및 개선 계획 필요 |
| **환경 제약** | 환경 제약으로 실행 불가 항목은 사전 정의 필요 |

**예외 승인 프로세스:**

1. 예외 항목 식별 및 문서화
2. 예외 승인 요청 (이유, 영향도, 개선 계획)
3. 승인 후 합격 기준에서 제외
4. 개선 계획 수립 및 추적

## 리포트 산출물 형태

### 표준화된 리포트 구조

```
chaos-toolkit-results-YYYYMMDD/
├── journal.json                      # 원본 Journal 파일
├── report.html                        # HTML 리포트
├── summary.md                         # 요약 리포트 (1~2페이지)
├── steady-state-hypothesis-results.md # Steady-State Hypothesis 결과 상세
└── reproduction-guide.md              # 재현 방법 (명령어/Experiment 파일)
```

### 요약 리포트 예시 (summary.md)

```markdown
# Chaos Toolkit 복원력 테스트 결과 요약

**실행 일시:** 2024-01-15 14:00:00 KST
**실험 제목:** Pod resilience test
**Kubernetes 버전:** v1.28.0

## 전체 결과

| 항목 | 결과 |
|------|------|
| **실험 상태** | completed |
| **Steady-State Hypothesis** | deviated: false |
| **실험 전 Probe** | ✅ 통과 |
| **Action** | ✅ 실행 완료 |
| **실험 후 Probe** | ✅ 통과 |

## 합격 여부

✅ **합격** - Steady-State Hypothesis 유지, Pod 자동 복구 확인

## 다음 단계

- [ ] CAT 다음 단계 진행 (성능/수용량 테스트)
- [ ] 정기 복원력 테스트 스케줄 설정
- [ ] 결과를 모니터링 시스템에 통합
```

### Steady-State Hypothesis 결과 리포트 예시

```markdown
# Steady-State Hypothesis 결과 상세

## 실험 전 Probe 결과

| Probe 이름 | 상태 | 결과 |
|-----------|------|------|
| **pod-exists-before** | ✅ 통과 | Pod 상태: Running |

## Action 실행 결과

| Action 이름 | 상태 | 결과 |
|------------|------|------|
| **delete-pod** | ✅ 실행 완료 | Pod 삭제 완료 |

## 실험 후 Probe 결과

| Probe 이름 | 상태 | 결과 |
|-----------|------|------|
| **pod-exists-after** | ✅ 통과 | Pod 상태: Running (자동 복구 확인) |

## 결론

✅ **Steady-State Hypothesis 유지** - 실험 전/후 Pod 상태가 "Running"으로 유지됨
```

## CAT 전체 흐름에서의 위치

### CAT 단계별 검증 질문

| 단계 | 카테고리 | 검증 질문(Assertion) | 도구 | 합격 기준 |
|------|---------|---------------------|------|----------|
| 1 | Conformance/Config | "클러스터가 공식 Conformance를 만족하는가?" | Sonobuoy | Non-disruptive Conformance 100% 통과 |
| 2 | Security | "보안 설정이 CIS 기준을 만족하는가?" | kube-bench | High/Critical 0건 |
| 3 | Performance/Scale | "성능이 요구 수준인가?" | kube-burner | p95 API latency < X ms |
| **4** | **Resilience/Fault Tolerance** | **"장애 상황에서도 정상 동작을 유지하는가?"** | **Chaos Toolkit** | **Steady-State Hypothesis 유지** |
| 5 | Automation | "검증이 자동화되었는가?" | CI/CD | 자동 실행 및 리포트 생성 |

### Gate 역할

```bash
# CAT 4단계: Chaos Toolkit 복원력 검증
chaos run experiment.json --journal-path journal.json

# Steady-State Hypothesis 검증
STATUS=$(cat journal.json | jq -r '.status')
DEVIATED=$(cat journal.json | jq -r '.steady-state-hypothesis.deviated')

if [ "$STATUS" != "completed" ] || [ "$DEVIATED" = "true" ]; then
  echo "❌ CAT 4단계 실패: Chaos Toolkit 복원력 검증 실패"
  exit 1
fi

echo "✅ CAT 4단계 통과: Chaos Toolkit 복원력 검증 성공"
# → 다음 단계 진행 (리포트/자동화)
```

## 관련 문서

- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 Chaos Toolkit 활용
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
