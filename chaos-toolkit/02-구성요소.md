# Chaos Toolkit 구성 요소

Chaos Toolkit은 다음 주요 구성 요소로 이루어져 있습니다.

## 아키텍처 개요

```
┌─────────────────┐
│  Chaos CLI      │  ← 사용자가 실행하는 명령어 도구
│  (chaos)        │
└────────┬────────┘
         │
         ↓
┌─────────────────────────────────────────────┐
│         Experiment (JSON/YAML)              │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Steady-State Hypothesis            │  │
│  │   - 실험 전 상태 확인 (Probes)        │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Method (Actions)                   │  │
│  │   - 장애 주입 (Pod 삭제, 노드 종료 등)│  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Steady-State Hypothesis            │  │
│  │   - 실험 후 상태 확인 (Probes)        │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Rollback (선택적)                  │  │
│  │   - 문제 발생 시 자동 복구            │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────────────┐
│         Journal (chaos-report.json)         │
│         - 실험 실행 결과 기록                │
└─────────────────────────────────────────────┘
         │
         ↓
┌─────────────────────────────────────────────┐
│         Report (HTML/PDF/Markdown)          │
│         - 실험 결과 리포트                   │
└─────────────────────────────────────────────┘
```

## 구성 요소 상세

### 1. CLI 유틸리티

커맨드라인에서 실행하는 실험 도구입니다.

| 명령어 | 기능 | 설명 |
|--------|------|------|
| `chaos run` | 실험 실행 | Experiment 파일을 실행하여 Chaos 테스트 수행 |
| `chaos validate` | 검증 | Experiment 파일 문법 검증 |
| `chaos init` | 초기화 | Experiment 파일 템플릿 생성 |
| `chaos discover` | 탐색 | 환경에서 사용 가능한 Actions/Probes 탐색 |
| `chaos report` | 리포트 생성 | Journal 파일을 HTML/PDF 등으로 변환 |

**설치 방법:**

```bash
# Python 3.8 이상 필요
pip install -U chaostoolkit

# Kubernetes Extension 설치
pip install -U chaostoolkit-kubernetes

# 리포팅 기능 설치
pip install -U chaostoolkit-reporting
```

### 2. Experiment (실험 정의)

JSON 또는 YAML 형식의 실험 정의 파일입니다.

**주요 구성:**

| 섹션 | 설명 |
|------|------|
| **title** | 실험 제목 |
| **description** | 실험 설명 |
| **steady-state-hypothesis** | 정상 상태 가설 (Probes 포함) |
| **method** | 실험 방법 (Actions 포함) |
| **rollbacks** | 복구 방법 (선택적) |

**예시 구조:**

```json
{
  "version": "1.0.0",
  "title": "Pod resilience test",
  "description": "Pod를 삭제했을 때 자동 복구되는지 테스트",
  "steady-state-hypothesis": {
    "title": "정상 상태 확인",
    "probes": [
      {
        "type": "probe",
        "name": "pod-exists",
        "provider": {
          "type": "python",
          "module": "chaosk8s.pod.probes",
          "func": "pod_status"
        }
      }
    ]
  },
  "method": [
    {
      "type": "action",
      "name": "delete-pod",
      "provider": {
        "type": "python",
        "module": "chaosk8s.pod.actions",
        "func": "delete_pod"
      }
    }
  ]
}
```

### 3. Steady-State Hypothesis (정상 상태 가설)

실험 전/후 시스템의 정상 상태를 정의하고 검증합니다.

| 구성 요소 | 설명 |
|----------|------|
| **Probes** | 상태 확인 작업 (예: Pod 존재 여부, API 응답 확인) |
| **Tolerance** | 허용 오차 (선택적) |
| **Scope** | 검증 범위 (선택적) |

**특징:**
- 실험 전 Probe 실행: 정상 상태인지 확인
- 실험 후 Probe 실행: 정상 상태를 유지하는지 확인
- Probe 실패 시 실험 중단 가능

### 4. Method (실험 방법)

장애를 주입하는 Actions를 정의합니다.

| 구성 요소 | 설명 |
|----------|------|
| **Actions** | 장애 주입 작업 (예: Pod 삭제, 노드 종료, 네트워크 지연) |
| **Pauses** | 대기 시간 (선택적) |
| **Tolerance** | 허용 오차 (선택적) |

**특징:**
- 여러 Actions를 순차적으로 실행 가능
- 각 Action 사이에 Pause(대기) 설정 가능
- Action 실패 시 Rollback 가능

### 5. Probes (프로브)

시스템 상태를 확인하는 작업입니다.

| Probe 타입 | 설명 | 예시 |
|-----------|------|------|
| **HTTP Probe** | HTTP 엔드포인트 응답 확인 | 서비스 헬스체크 |
| **Kubernetes Probe** | K8s 리소스 상태 확인 | Pod 존재, Deployment 상태 |
| **Process Probe** | 프로세스 상태 확인 | 프로세스 실행 여부 |
| **Custom Probe** | 커스텀 Python 함수 | 자체 정의 검증 로직 |

### 6. Actions (액션)

장애를 주입하는 작업입니다.

| Action 타입 | 설명 | 예시 |
|------------|------|------|
| **Kubernetes Action** | K8s 리소스 조작 | Pod 삭제, 노드 종료 |
| **HTTP Action** | HTTP 요청 | API 호출, 트래픽 증가 |
| **Process Action** | 프로세스 조작 | 프로세스 종료 |
| **Custom Action** | 커스텀 Python 함수 | 자체 정의 장애 주입 |

### 7. Rollback (롤백)

실험 후 문제 발생 시 자동 복구하는 작업입니다.

| Rollback 타입 | 설명 |
|--------------|------|
| **Automatic** | 실험 후 자동 실행 (선택적) |
| **Manual** | 수동 실행 |
| **Conditional** | 조건부 실행 |

**특징:**
- 실험 실패 시 자동 롤백 가능
- Rollback이 실패해도 실험은 계속 진행 가능
- Rollback 없이 실험 가능 (테스트 목적)

### 8. Journal (저널)

실험 실행 결과를 기록하는 파일입니다.

| 항목 | 설명 |
|------|------|
| **파일명** | `chaos-report.json` 또는 `journal.json` |
| **형식** | JSON 형식 |
| **내용** | 실험 실행 과정, Probe/Action 결과, 오류 정보 |

**특징:**
- 실험 실행 시 자동 생성
- 리포트 생성의 입력 데이터로 사용
- 여러 실험 Journal 병합 가능

### 9. Report (리포트)

Journal 파일을 기반으로 생성하는 실험 결과 리포트입니다.

| 리포트 형식 | 설명 |
|------------|------|
| **HTML** | 웹 브라우저에서 확인 가능한 리포트 |
| **PDF** | PDF 문서 형식 리포트 |
| **Markdown** | 마크다운 형식 리포트 |

**생성 방법:**

```bash
chaos report journal.json report.html
```

## Extensions (확장)

다양한 환경을 지원하는 확장 프로그램입니다.

| Extension | 설명 | 용도 |
|----------|------|------|
| **chaostoolkit-kubernetes** | Kubernetes 리소스 조작 | K8s 클러스터 장애 테스트 |
| **chaostoolkit-aws** | AWS 리소스 조작 | AWS 인프라 장애 테스트 |
| **chaostoolkit-azure** | Azure 리소스 조작 | Azure 인프라 장애 테스트 |
| **chaostoolkit-prometheus** | Prometheus 메트릭 조회 | 메트릭 기반 Probe/Action |

## Kubernetes Operator

Kubernetes 클러스터 내에서 실험을 자동 실행하는 Operator입니다.

| 특징 | 설명 |
|------|------|
| **CRD 기반** | Experiment를 Kubernetes CRD로 정의 |
| **자동 실행** | Operator가 실험을 자동 실행 및 관리 |
| **자동 정리** | 실험 완료 후 리소스 자동 정리 |
| **RBAC 지원** | Kubernetes RBAC로 권한 관리 |

## 실행 흐름

```bash
# 1. 사용자가 CLI 명령 실행
chaos run experiment.json

# 2. Steady-State Hypothesis 검증 (실험 전)
chaos → Probes 실행 → 정상 상태 확인

# 3. Method 실행 (장애 주입)
chaos → Actions 실행 → Pod 삭제, 노드 종료 등

# 4. Steady-State Hypothesis 검증 (실험 후)
chaos → Probes 실행 → 정상 상태 유지 확인

# 5. Journal 생성
chaos → chaos-report.json 생성 → 실험 결과 기록

# 6. 리포트 생성 (선택적)
chaos report chaos-report.json report.html
```

## 관련 문서

- [03-설치및사용법.md](./03-설치및사용법.md) - 설치부터 실행까지 기본 워크플로우
- [04-실험-정의.md](./04-실험-정의.md) - Experiment 파일 작성 방법
- [05-Kubernetes-통합.md](./05-Kubernetes-통합.md) - Kubernetes Operator 상세
