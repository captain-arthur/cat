# Chaos Toolkit 설치 및 사용법

Chaos Toolkit을 설치하고 실행하여 결과를 확인하는 전체 워크플로우를 설명합니다.

## 설치

### Python 환경 준비

```bash
# Python 3.8 이상 필요
python3 --version

# 가상환경 생성 (권장)
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# 또는
venv\Scripts\activate  # Windows
```

### 기본 설치

```bash
# Chaos Toolkit 설치
pip install -U chaostoolkit

# 설치 확인
chaos --version
```

### Kubernetes Extension 설치

```bash
# Kubernetes 리소스 조작용 Extension
pip install -U chaostoolkit-kubernetes

# 설치 확인
chaos --help
```

### 리포팅 기능 설치 (선택적)

```bash
# Journal → HTML/PDF 리포트 변환
pip install -U chaostoolkit-reporting

# 설치 확인
chaos report --help
```

## 기본 워크플로우

### 1. 실험 파일 작성

Experiment 파일을 JSON 또는 YAML 형식으로 작성합니다.

**예시: Pod 삭제 후 자동 복구 테스트**

```json
{
  "version": "1.0.0",
  "title": "Pod resilience test",
  "description": "Pod를 삭제했을 때 자동으로 복구되는지 테스트",
  "steady-state-hypothesis": {
    "title": "정상 상태 확인",
    "probes": [
      {
        "type": "probe",
        "name": "pod-exists",
        "provider": {
          "type": "python",
          "module": "chaosk8s.pod.probes",
          "func": "read_pods",
          "arguments": {
            "label_selector": "app=test-app",
            "ns": "default"
          }
        },
        "tolerance": {
          "type": "jsonpath",
          "path": "$.items[*].status.phase",
          "expect": [
            "Running"
          ]
        }
      }
    ]
  },
  "method": [
    {
      "type": "action",
      "name": "delete-pod",
      "provider": {
        "type": "python",
        "module": "chaosk8s.pod.actions",
        "func": "delete_pods",
        "arguments": {
          "label_selector": "app=test-app",
          "ns": "default"
        }
      },
      "pauses": {
        "after": 30
      }
    }
  ],
  "rollbacks": []
}
```

### 2. 실험 검증

실험 파일 문법을 검증합니다:

```bash
chaos validate experiment.json
```

### 3. 실험 실행

```bash
# 기본 실행
chaos run experiment.json

# Journal 파일 지정
chaos run experiment.json --journal-path journal.json

# 로그 레벨 지정
chaos run experiment.json --log-level debug
```

**옵션 설명:**

| 옵션 | 설명 | 필수 여부 |
|------|------|----------|
| `--journal-path` | Journal 파일 경로 지정 | 선택 (기본값: `chaos-report.json`) |
| `--log-level` | 로그 레벨 (debug, info, warning, error) | 선택 (기본값: info) |
| `--dry` | Dry-run 모드 (실제 실행 없이 검증만) | 선택 |

### 4. 결과 확인

**Journal 파일 확인:**

```bash
# Journal 파일 구조 확인
cat chaos-report.json | jq .

# 실험 상태 확인
cat chaos-report.json | jq '.status'

# Steady-State Hypothesis 결과 확인
cat chaos-report.json | jq '.steady-state-hypothesis'

# Method 실행 결과 확인
cat chaos-report.json | jq '.run'
```

**실험 상태 값:**

| 상태 | 의미 |
|------|------|
| `completed` | 실험 완료 (성공) |
| `failed` | Steady-State Hypothesis 실패 |
| `aborted` | 실험 중단 |

### 5. 리포트 생성

Journal 파일을 HTML/PDF 등으로 변환합니다:

```bash
# HTML 리포트 생성
chaos report journal.json report.html

# PDF 리포트 생성 (선택적)
chaos report journal.json report.pdf --export-format pdf

# Markdown 리포트 생성
chaos report journal.json report.md --export-format markdown
```

## 실전 예시

### 예시 1: Pod 자동 복구 테스트

```bash
# 1. 실험 파일 작성
cat > pod-resilience.json <<EOF
{
  "version": "1.0.0",
  "title": "Pod resilience test",
  "description": "Pod를 삭제했을 때 자동으로 복구되는지 테스트",
  "steady-state-hypothesis": {
    "title": "정상 상태 확인",
    "probes": [
      {
        "type": "probe",
        "name": "pod-exists",
        "provider": {
          "type": "python",
          "module": "chaosk8s.pod.probes",
          "func": "read_pods",
          "arguments": {
            "label_selector": "app=test-app",
            "ns": "default"
          }
        }
      }
    ]
  },
  "method": [
    {
      "type": "action",
      "name": "delete-pod",
      "provider": {
        "type": "python",
        "module": "chaosk8s.pod.actions",
        "func": "delete_pods",
        "arguments": {
          "label_selector": "app=test-app",
          "ns": "default"
        }
      },
      "pauses": {
        "after": 30
      }
    }
  ]
}
EOF

# 2. 실험 실행
chaos run pod-resilience.json

# 3. 결과 확인
cat chaos-report.json | jq '.status'

# 4. 리포트 생성
chaos report chaos-report.json report.html
```

### 예시 2: HTTP 서비스 응답 확인

```bash
# HTTP Probe를 사용한 실험 예시
cat > http-test.json <<EOF
{
  "version": "1.0.0",
  "title": "HTTP service test",
  "description": "HTTP 서비스가 정상 응답하는지 확인",
  "steady-state-hypothesis": {
    "title": "HTTP 200 응답 확인",
    "probes": [
      {
        "type": "probe",
        "name": "http-status",
        "provider": {
          "type": "http",
          "url": "https://example.com/health",
          "method": "GET"
        },
        "tolerance": 200
      }
    ]
  },
  "method": []
}
EOF

chaos run http-test.json
```

## 고급 사용법

### Kubernetes kubeconfig 지정

```bash
# kubeconfig 경로 지정
export KUBECONFIG=~/.kube/config

# 또는 환경 변수로 지정
chaos run experiment.json --var-file secrets.yaml
```

### 실험 템플릿 생성

```bash
# Kubernetes 실험 템플릿 생성
chaos init kubernetes

# 또는 수동으로 생성
chaos discover chaostoolkit-kubernetes
```

### 실험 탐색

```bash
# 사용 가능한 Probes/Actions 탐색
chaos discover chaostoolkit-kubernetes

# 특정 함수 탐색
chaos discover chaostoolkit-kubernetes --module chaosk8s.pod
```

## 문제 해결

### 일반적인 문제

#### 1. Kubernetes 연결 오류

```bash
# kubeconfig 확인
kubectl config view

# Kubernetes 클러스터 연결 확인
kubectl cluster-info

# 권한 확인
kubectl auth can-i create pods --all-namespaces
```

#### 2. Extension 설치 오류

```bash
# Extension 재설치
pip uninstall chaostoolkit-kubernetes
pip install -U chaostoolkit-kubernetes

# 설치된 Extension 확인
pip list | grep chaostoolkit
```

#### 3. Journal 파일이 생성되지 않음

```bash
# Journal 경로 확인
chaos run experiment.json --journal-path ./journal.json

# 로그 확인
cat chaostoolkit.log
```

#### 4. Steady-State Hypothesis 실패

```bash
# Journal 파일에서 실패 원인 확인
cat chaos-report.json | jq '.steady-state-hypothesis'

# Probe 결과 확인
cat chaos-report.json | jq '.steady-state-hypothesis.probes[*]'
```

## 관련 문서

- [04-실험-정의.md](./04-실험-정의.md) - Experiment 파일 작성 상세 가이드
- [06-CAT-활용.md](./06-CAT-활용.md) - CAT 관점에서의 활용
- [08-실무-체크리스트.md](./08-실무-체크리스트.md) - 실무 적용 시 확인 사항
