# ClusterLoader2 구성 요소

ClusterLoader2는 다음 주요 구성 요소로 이루어져 있습니다.

## 아키텍처 개요

```
┌─────────────────┐
│ ClusterLoader2  │  ← 사용자가 실행하는 CLI 도구
│     CLI         │
└────────┬────────┘
         │ kubectl/API
         ↓
┌─────────────────────────────────────────────┐
│         Kubernetes Cluster                  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   리소스 생성/삭제/관리                │  │
│  │   - Pod, Deployment, Namespace 등    │  │
│  │   - Phases & Steps 기반 실행         │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Measurements (내장 측정)            │  │
│  │   - PodStartupLatency                 │  │
│  │   - APIAvailability                   │  │
│  │   - APIResponsiveness                 │  │
│  │   - SchedulingThroughput              │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   Prometheus (선택적, 메트릭 수집)    │  │
│  │   - etcd metrics                      │  │
│  │   - Resource usage                    │  │
│  │   - Control-plane metrics             │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │   결과 수집 및 리포트                  │  │
│  │   - Summary 리포트 (p50, p90, p99)    │  │
│  │   - Threshold 검증                     │  │
│  │   - 리포트 파일 생성                   │  │
│  └──────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

## 구성 요소 상세

### 1. CLI 유틸리티

커맨드라인에서 실행하는 테스트 도구입니다.

| 명령어 | 기능 | 설명 |
|--------|------|------|
| `clusterloader2` | 테스트 실행 | TestConfig 파일 기반 테스트 실행 |

**주요 플래그:**

| 플래그 | 설명 | 필수 여부 |
|--------|------|----------|
| `--testconfig` | 테스트 설정 파일 경로 | 필수 |
| `--kubeconfig` | kubeconfig 파일 경로 | 선택 (기본값: `~/.kube/config`) |
| `--provider` | 클러스터 provider (gke, gce, aws, kubemark 등) | 선택 |
| `--report-dir` | 리포트 출력 디렉토리 | 선택 (지정 안 하면 로그만 출력) |
| `--nodes` | 노드 수 | 선택 |
| `--masterip` | 마스터 노드 IP | 선택 |

**설치 방법:**

```bash
# 1. Kubernetes perf-tests 리포지토리 클론
git clone https://github.com/kubernetes/perf-tests.git
cd perf-tests/clusterloader2

# 2. 빌드
go build -o clusterloader2 ./cmd/

# 3. 실행
./clusterloader2 --testconfig=testing/load/config.yaml --kubeconfig=$HOME/.kube/config
```

### 2. TestConfig (테스트 설정 파일)

YAML 또는 JSON 형식의 테스트 정의 파일입니다.

**주요 구성:**

| 섹션 | 설명 |
|------|------|
| **phases** | 테스트 단계 정의 (생성, 대기, 측정, 삭제 등) |
| **steps** | 각 phase 내 세부 단계 |
| **modules** | 재사용 가능한 모듈 정의 |
| **objectTemplate** | Kubernetes 객체 템플릿 |
| **measurements** | 수집할 지표 정의 |
| **tuningSets** | 리소스 생성 속도 제어 (rate limit, stepping 등) |

**예시 구조:**

```yaml
phases:
- namespaceRange:
    min: 1
    max: 10
  replicasPerNamespace: 20
  tuningSet:
    rateLimit:
      delay: 10ms
  objectBundle:
    - basename: test-pod
      objectTemplatePath: pod-template.yaml
      
measurements:
- Identifier: PodStartupLatency
  Method: PodStartupLatency
- Identifier: APIAvailability
  Method: APIAvailability
```

### 3. Modules (모듈)

재사용 가능한 테스트 구성 모듈입니다.

| 특징 | 설명 |
|------|------|
| **모듈화** | 공통 테스트 패턴을 모듈로 분리하여 재사용 |
| **파라미터 주입** | 모듈에 파라미터를 주입하여 다양한 변형 가능 |
| **조합 가능** | 여러 모듈을 조합하여 복잡한 테스트 구성 |

### 4. Object Template (객체 템플릿)

Kubernetes 객체 정의 템플릿입니다.

| 특징 | 설명 |
|------|------|
| **템플릿 변수** | `{{.Name}}`, `{{.Index}}`, `{{.Namespace}}` 등 사용 |
| **재사용** | 동일 템플릿으로 다양한 객체 생성 |
| **동적 생성** | 테스트 실행 중 파라미터 주입하여 객체 생성 |

**템플릿 예시:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
spec:
  containers:
  - name: test-container
    image: busybox:1.36
```

### 5. Measurements (측정 지표)

내장된 성능 지표 수집 기능입니다.

| 측정 항목 | 설명 | Prometheus 필요 |
|----------|------|-----------------|
| **PodStartupLatency** | Pod 생성 → Running까지 시간 | 선택 |
| **APIAvailability** | API Server 가용성 (`/readyz` 체크) | 선택 |
| **APIResponsiveness** | API Server 응답 시간 (latency) | 선택 (Prometheus 사용 시 더 정확) |
| **SchedulingThroughput** | 스케줄러 처리량 | 선택 |
| **ResourceUsageSummary** | CPU/메모리 사용량 요약 | Prometheus 필요 |
| **EtcdMetrics** | etcd 성능 메트릭 | Prometheus 필요 |
| **WaitForControlledPodsRunning** | Controlled Pod들이 Running 상태까지 대기 | 선택 |

**특징:**
- 일부 measurements는 Prometheus 없이도 동작 (PodStartupLatency 등)
- Prometheus 있으면 더 풍부한 메트릭 수집 가능
- 결과는 p50, p90, p99 등 percentile로 제공

### 6. Prometheus 통합 (선택적)

Prometheus를 통한 고급 메트릭 수집입니다.

| 기능 | 설명 |
|------|------|
| **메트릭 수집** | Prometheus에서 메트릭을 쿼리하여 수집 |
| **자동 설치/정리** | 테스트 실행 시 Prometheus 스택 자동 설치/정리 가능 |
| **컨트롤 플레인 메트릭** | API Server, etcd, scheduler 등 메트릭 수집 |
| **리소스 사용량** | 노드별 CPU/메모리 사용량 상세 분석 |

### 7. Tuning Sets (튜닝 세트)

리소스 생성 속도 및 패턴 제어입니다.

| 옵션 | 설명 |
|------|------|
| **rateLimit** | 리소스 생성 속도 제한 (delay 설정) |
| **stepping** | 단계별 생성 (batch 단위) |
| **batch** | 일괄 생성 후 대기 |

## 실행 흐름

```bash
# 1. 사용자가 CLI 명령 실행
clusterloader2 --testconfig=config.yaml --report-dir=./reports

# 2. CLI가 TestConfig 파일 파싱
ClusterLoader2 → YAML 파싱 → phases, measurements, tuningSets 확인

# 3. Phases 실행 (순차적)
ClusterLoader2 → Phase 1: Namespace 생성
               → Phase 2: Pod 생성 (rate limit 적용)
               → Phase 3: 대기 (Pod Ready까지)
               → Phase 4: Measurements 수행

# 4. Measurements 수집
ClusterLoader2 → PodStartupLatency 측정
               → APIAvailability 측정
               → (Prometheus 있으면) APIResponsiveness, ResourceUsage 측정

# 5. 결과 분석
ClusterLoader2 → 통계 계산 (p50, p90, p99)
               → Threshold 검증
               → Summary 리포트 생성

# 6. 리소스 정리 (설정에 따라)
ClusterLoader2 → (cleanup 옵션 있으면) Namespace 삭제
```

## 관련 문서

- [03-설치및사용법.md](./03-설치및사용법.md) - 설치부터 실행까지 기본 워크플로우
- [04-워크로드-시나리오.md](./04-워크로드-시나리오.md) - 워크로드 시나리오 상세
