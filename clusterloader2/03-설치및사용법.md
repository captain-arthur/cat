# ClusterLoader2 설치 및 사용법

ClusterLoader2를 설치하고 실행하여 결과를 확인하는 전체 워크플로우를 설명합니다.

## 설치

### 소스에서 빌드 (권장)

ClusterLoader2는 Kubernetes 공식 리포지토리의 일부이므로 소스에서 빌드해야 합니다.

```bash
# 1. Kubernetes perf-tests 리포지토리 클론
git clone https://github.com/kubernetes/perf-tests.git
cd perf-tests/clusterloader2

# 2. Go 환경 확인 (Go 1.18 이상 필요)
go version

# 3. 빌드
go build -o clusterloader2 ./cmd/

# 4. PATH에 추가 (선택적)
sudo mv clusterloader2 /usr/local/bin/
# 또는
export PATH=$PATH:$(pwd)
```

### 설치 확인

```bash
clusterloader2 --help
```

## 기본 워크플로우

### 1. TestConfig 파일 준비

테스트 시나리오를 YAML 형식으로 정의합니다.

```yaml
# simple-test.yaml 예시
phases:
- namespaceRange:
    min: 1
    max: 10
  replicasPerNamespace: 20
  tuningSet:
    rateLimit:
      delay: 10ms
  objectBundle:
    - basename: test-pod
      objectTemplatePath: pod-template.yaml

measurements:
- Identifier: PodStartupLatency
  Method: PodStartupLatency
- Identifier: APIAvailability
  Method: APIAvailability
```

### 2. Object Template 준비

Kubernetes 객체 템플릿을 준비합니다.

```yaml
# pod-template.yaml 예시
apiVersion: v1
kind: Pod
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  labels:
    app: test-app
spec:
  containers:
  - name: test-container
    image: busybox:1.36
    command: ["sleep", "3600"]
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
```

### 3. 테스트 실행

```bash
# 기본 실행
clusterloader2 \
  --testconfig=simple-test.yaml \
  --kubeconfig=$HOME/.kube/config \
  --report-dir=./reports

# Provider 지정 (GKE, GCE, AWS 등)
clusterloader2 \
  --testconfig=simple-test.yaml \
  --provider=gke \
  --kubeconfig=$HOME/.kube/config \
  --report-dir=./reports

# 노드 수 지정
clusterloader2 \
  --testconfig=simple-test.yaml \
  --nodes=3 \
  --report-dir=./reports
```

**주요 플래그:**

| 플래그 | 설명 | 필수 여부 |
|--------|------|----------|
| `--testconfig` | TestConfig 파일 경로 | 필수 |
| `--kubeconfig` | kubeconfig 파일 경로 | 선택 (기본값: `~/.kube/config`) |
| `--provider` | 클러스터 provider (gke, gce, aws, kubemark 등) | 선택 |
| `--report-dir` | 리포트 출력 디렉토리 | 선택 (지정 안 하면 로그만 출력) |
| `--nodes` | 노드 수 | 선택 |
| `--masterip` | 마스터 노드 IP | 선택 |

### 4. 결과 확인

```bash
# 리포트 디렉토리 확인
ls -la reports/

# Summary 리포트 확인
cat reports/summary.txt

# 상세 리포트 확인 (JSON 형식일 수 있음)
cat reports/*.json
```

**생성되는 파일:**

| 파일 | 설명 |
|------|------|
| `summary.txt` | 테스트 실행 요약 (p50, p90, p99 등) |
| `*.json` | 상세 메트릭 데이터 (measurements별) |

### 5. 리소스 정리

ClusterLoader2는 기본적으로 자동 cleanup을 하지 않습니다.

```bash
# TestConfig에 cleanup phase가 있으면 자동 정리
# 없으면 수동으로 네임스페이스 삭제

# 수동 정리
kubectl get namespaces | grep test-
kubectl delete namespace test-ns-1 test-ns-2 ...

# 또는 TestConfig에 cleanup phase 추가
phases:
# ... 생성 phases ...
- phase: cleanup
  namespaceRange:
    min: 1
    max: 10
  deleteAll: true
```

## 고급 사용법

### Prometheus 통합

Prometheus가 클러스터에 설치되어 있으면 더 풍부한 메트릭을 수집할 수 있습니다.

```yaml
# TestConfig에 Prometheus 설정 추가
phases:
# ... phases ...

measurements:
- Identifier: PodStartupLatency
  Method: PodStartupLatency
- Identifier: APIResponsiveness
  Method: APIResponsivenessPrometheusSimple
- Identifier: ResourceUsageSummary
  Method: ResourceUsageSummary
```

**Prometheus 필요 measurements:**
- `APIResponsivenessPrometheusSimple`: API Server 응답 시간
- `ResourceUsageSummary`: CPU/메모리 사용량
- `EtcdMetrics`: etcd 성능 메트릭

### Modules 사용

재사용 가능한 모듈을 만들어 테스트를 구조화할 수 있습니다.

```yaml
# config.yaml
modules:
- path: modules/pod-creation.yaml
  name: pod-creation

phases:
- namespaceRange:
    min: 1
    max: 10
  module:
    name: pod-creation
    params:
      replicas: 20
```

### Tuning Sets로 속도 제어

리소스 생성 속도를 제어합니다.

```yaml
phases:
- namespaceRange:
    min: 1
    max: 10
  replicasPerNamespace: 100
  tuningSet:
    rateLimit:
      delay: 100ms  # 각 생성 사이 100ms 대기
    stepping:
      stepSize: 10  # 10개씩 생성
      pause: 1s     # 10개 생성 후 1초 대기
```

## 실전 예시

### 예시 1: 기본 Pod 생성 테스트

```yaml
# pod-test.yaml
phases:
- namespaceRange:
    min: 1
    max: 5
  replicasPerNamespace: 10
  tuningSet:
    rateLimit:
      delay: 10ms
  objectBundle:
    - basename: test-pod
      objectTemplatePath: pod-template.yaml

measurements:
- Identifier: PodStartupLatency
  Method: PodStartupLatency
```

```bash
clusterloader2 --testconfig=pod-test.yaml --report-dir=./reports
```

### 예시 2: Deployment 스케일 테스트

```yaml
# deployment-scale.yaml
phases:
- namespaceRange:
    min: 1
    max: 3
  replicasPerNamespace: 5
  objectBundle:
    - basename: test-deployment
      objectTemplatePath: deployment-template.yaml

measurements:
- Identifier: PodStartupLatency
  Method: PodStartupLatency
- Identifier: APIAvailability
  Method: APIAvailability
```

## 관련 문서

- [02-구성요소.md](./02-구성요소.md) - 구성 요소 상세 설명
- [04-워크로드-시나리오.md](./04-워크로드-시나리오.md) - TestConfig 및 시나리오 예시
